
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Absurdity and Farce</title>
  <meta name="author" content="Bret McGuire">

  
  <meta name="description" content="Originally published at Heuristic Fencepost In an attempt to make my Ruby code a bit more idiomatic I&#8217;ve been spending a bit of time recently &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://absurdfarce.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Absurdity and Farce" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Absurdity and Farce</a></h1>
  
    <h2>Searching for the sublime among the ridiculous</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:absurdfarce.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/10/ruby-perl-and-eloquence/">Ruby, Perl and Eloquence</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-10T12:00:00-05:00" pubdate data-updated="true">Jul 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2012/07/ruby-perl-and-eloquence.html">Heuristic Fencepost</a></p>

<p>In an attempt to make my Ruby code a bit more idiomatic I&#8217;ve been spending a bit of time recently with Russ Olsen&#8217;s excellent <a href="http://eloquentruby.com">Eloquent Ruby</a>. There are many reasons to love writing Ruby code, not least of which is that Ruby deploys the same terse but expressive power of Perl while employing better overall principles of programming. The effect isn&#8217;t universal; on occasion my problems with Ruby look quite a bit like my problems with Perl. Given the overall elegance of the language it seems likely that there&#8217;s a &#8220;better&#8221; (or at least more idiomatic) way to accomplish my goal. And so I turn to <em>Eloquent Ruby</em>.</p>

<p>As an example of this tension consider the following example.</p>

<p>Perl has a well-deserved reputation for efficiently processing text files with regular expressions. We&#8217;ll consider an example from another text I&#8217;ve been spending a bit of time with: Hofstadter&#8217;s seminal <a href="http://en.wikipedia.org/wiki/G%C3%B6del,_Escher,_Bach">Godel, Escher, Bach</a>. A simple implementation of the productions of the MIU system in Perl [1] might look like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="nb">open</span> <span class="n">INFILE</span><span class="p">,</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="sr">&lt;INFILE&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">chomp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /#.*/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1IU\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.+?)I$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;M$1$1\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^M(.+)$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1U$2\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)III(.*)$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1$2\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)UU(.*)$/</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reasonable enough, but there&#8217;s a lot of magic going on here. We&#8217;re relying on the &#8220;magic&#8221; variable $_ to access the current line, and to make things worse we have to obtain those lines using the INFILE identifier that only has meaning due to a side effect of the open() call [2]. There&#8217;s also those &#8220;magic&#8221; $1 and $2 variables for accessing capture groups in a regex.</p>

<p>The Ruby version is both slightly shorter and a bit cleaner:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span> <span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">next</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/#.*/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">IU</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.+)I$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;M</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}#{</span><span class="vg">$1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^M(.+)$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">U</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.*)III(.*)$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}#{</span><span class="vg">$2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.*)UU(.*)$/</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve made some nice strides here. The use of File.new() allows us to avoid open() and it&#8217;s side effects. The use of a code block allows us to remove the global $_ in favor of a scoped variable line.</p>

<p>But we&#8217;re still stuck with $1 and $2 for those capture groups.</p>

<p>One can imagine an elegant object-oriented solution based on match objects. Any such implementation would have to accomplish three things:</p>

<ul>
<li>The match object will be used as the condition of an if/unless expression so nil should be returned if there&#8217;s no match</li>
<li>The match object should be bound to a variable name in scope</li>
<li>References to capture groups in the if-clause should use the scoped variable rather than the $1,$2, etc.</li>
</ul>


<p>But remember, this exercise is only useful if we don&#8217;t have to compromise on elegance. If all we&#8217;re after is an explicit object-oriented solution we could go with the Python version:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'>
</span><span class='line'><span class="n">re_c</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;#.*&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.+?)I$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^M(.+)$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*)III(.*)$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re4</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*)UU(.*)$&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])]:</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">re_c</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span><span class='line'>        <span class="k">continue</span>
</span><span class='line'>    <span class="n">m1</span> <span class="o">=</span> <span class="n">re1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m1</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m1</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;IU&quot;</span>
</span><span class='line'>    <span class="n">m2</span> <span class="o">=</span> <span class="n">re2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;M&quot;</span> <span class="o">+</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">m3</span> <span class="o">=</span> <span class="n">re3</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m3</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m3</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;U&quot;</span> <span class="o">+</span> <span class="n">m3</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">m4</span> <span class="o">=</span> <span class="n">re4</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m4</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m4</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m4</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s probably not what we want. [3]</p>

<p>After pondering this question for a bit we realize we may not be in such a bad spot. /regex/.match(str) already returns nil if there is no match so our first requirement is satisfied. Assignment is just another expression, so our match object (or nil) will be returned to the if-expression test, helping us with our second goal. And match objects provide access to capture groups using []. So long as the assigned variable is in scope we should have everything we need. A bit of scuffling [4] brings us to the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Implementation of the productions for the MIU system with match objects</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span> <span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">next</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/#.*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">foo</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">IU</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.+)I$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;M</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^M(.+)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">U</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.*)III(.*)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.*)UU(.*)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example is free of any &#8220;magic&#8221; variables, although we have sacrificed a bit on the clarity front. It&#8217;s also worth noting that we could have accomplished something very similar in Perl:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># Implementation of the productions for the MIU system with match objects</span>
</span><span class='line'><span class="nb">open</span> <span class="n">INFILE</span><span class="p">,</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="sr">&lt;INFILE&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">chomp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /#.*/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]IU\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.+?)I$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;M$foo[0]$foo[0]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^M(.+)$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]U$foo[1]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)III(.*)$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]$foo[1]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)UU(.*)$/</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This implementation is hardly idiomatic. It&#8217;s also quite a bit less clear than our earlier efforts in the language.</p>

<p>Where does this leave us? Do we keep in touch with our Perl roots and live with $1 in order to keep things terse and expressive? Do we sacrifice a bit of clarity and go with an object-oriented approach? Or do we do something else entirely?</p>

<p>Answers to this question (and others like it) are what I&#8217;m hoping to get out of <em>Eloquent Ruby</em>.</p>

<p>[1] We&#8217;re ignoring nasty things like error handling and complex edge cases in order to keep the conversation focused.</p>

<p>[2] We could use lexical file handles here but that doesn&#8217;t really change the underlying point. Even in that case we still have to call open() in order for $fh to be useful.</p>

<p>[3] Python does a lot of things very, very well, but this solution to this problem seems unnecessarily verbose.</p>

<p>[4] The requirement to declare foo in advance when using the modifier form of if was a bit surprising. Shifting to an if expression removed this requirement; in that case assignment in the condition. The upcoming Perl version also didn&#8217;t require this advance declaration when using an equivalent to the modifier form. An MRI quirk, perhaps?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/05/ruby-and-concurrency-design-with-actors-and-akka/">Ruby and Concurrency: Design With Actors and Akka</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-05T12:00:00-06:00" pubdate data-updated="true">Jan 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2012/01/ruby-and-concurrency-design-with-actors.html">Heuristic Fencepost</a></p>

<p>In a <a href="http://absurdfarce.github.io/blog/2011/09/12/ruby-and-concurrency-the-mechanics-of-akka-and-jruby/">semi-recent post</a> we looked at how we might define actors in JRuby using a combination of Akka and code blocks. That post was very focused on the process of creating actors; we didn&#8217;t necessarily consider how to build systems with actors and/or whether Ruby might be helpful in doing so. There are plenty of issues to ponder here, but before we dig in let&#8217;s take a step back and talk briefly about some of the characteristics of actors.</p>

<p>Actors implement a shared-nothing model for concurrency. Mutable system state should be contained by one or more actors in the system. This state is not exposed to external entities directly; it can only be accessed or modified via messages sent to the actor. Since the actor is the only player in this drama that can access the state it contains there is no need to lock or synchronize state access. It should be fairly clear that an actor consists of some amount of mutable system state and some logic for handling incoming messages&#8230; and not much more.</p>

<p>Okay, sounds great&#8230; but how does it work in practice? We&#8217;ll consider this question by way of an alogrithm that by now should be pretty familiar: prime number generation using the <a href="http://en.wikipedia.org/wiki/Sieve_of_eratosthenes">Sieve of Eratosthenes</a>. We considered this chestnut (or perhaps you prefer &#8220;war horse&#8221; at this point) in a <a href="http://heuristic-fencepost.blogspot.com/2010/10/concurrent-prime-factorization-in-go.html">previous post</a> discussing an implementation of this algorithm in the <a href="http://golang.org">Go language</a>. Let&#8217;s review that implementation and see what else we can do with it.</p>

<p>The support of lightweight goroutines in Go encouraged a pipeline implementation with one goroutine per discovered prime. We can think of the &#8220;state&#8221; of this system as the total set of discovered primes. Each goroutine knows only about the prime it contains and the channel where candidates should be sent if they &#8220;pass&#8221; (i.e. do not divide evenly into it&#8217;s prime number). Once the goroutine is created it&#8217;s state doesn&#8217;t change. New state is added by creating a new goroutine for a newly-discovered prime. State is never deleted; once a prime is discovered removing it from consideration is non-sensical. As a consequence state is completely distributed; no entity in the system knows about all discovered primes.</p>

<p>We also note that the algorithm described here isn&#8217;t very friendly to parallel decomposition [1]. Candidate values are compared to previously discovered primes one at a time: if the candidate passes the test it&#8217;s allowed to move on, otherwise no further evaluation occurs. This technique is referred to as &#8220;fail-fast&#8221; behaviour; if a value fails a test it doesn&#8217;t lead to any wasteful extra work. The concurrent approach is quite different: compare the candidate to all discovered primes at once and return success only if all tests pass. Comparisons are done independently, so even if the &#8220;first&#8221; [2] comparison fails all other comparisons still execute. We lose our fail-fast behaviour but gain the ability to decompose the entire process into smaller jobs that can execute in parallel. A trade-off in engineering&#8230; surprising, I know.</p>

<p>We&#8217;ll set out to implement the Sieve of Eratosthenes in Ruby using JRuby and Akka. Our new implementation will have more of a bias towards parallelism; this time we&#8217;re okay with throwing away some work. Clearly we&#8217;ll need an actor to compare a candidate to one or more discovered primes; that is, after all, why we&#8217;re here. We can think of these actors as maintaining the state of our system (just like the goroutines in the Go implementation) so we&#8217;ll borrow a term from MVC and call these &#8220;model&#8221; actors. Concurrently evaluating candidates against these models implies an organizing actor that is aware of all models; it seems natural to call this the &#8220;controller&#8221; actor. To keep things simple we don&#8217;t want to support an unlimited number of models so we create a fixed-size &#8220;pool&#8221; and distribute system state (i.e. the set of discovered primes) between these models. When a new prime is discovered the controller will be responsible for adding that prime to an existing model.</p>

<p>The implementation in Ruby looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;lib/akka-actor-1.2.jar&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;lib/scala-library.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.Actors&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActor&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActorFactory&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Sieve</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Basic Enumerable wrapper for a Controller actor... just a convenience thing really</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Primes</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@controller</span> <span class="o">=</span> <span class="n">controller</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">each</span>
</span><span class='line'>      <span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">yield</span> <span class="vi">@controller</span><span class="o">.</span><span class="n">sendRequestReply</span><span class="p">(</span><span class="ss">:next</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Enumerable implementation representing the set of prime number candidates &gt; 10.  Use of an</span>
</span><span class='line'>  <span class="c1"># enumerable here allows us to isolate the state associated with candidate selection to this</span>
</span><span class='line'>  <span class="c1"># class, freeing up the model and controller actors to focus on other parts of the computation</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Candidates</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="c1"># Note that this initial value is never actually returned; we&#39;re only setting the stage for the</span>
</span><span class='line'>      <span class="c1"># first increment to generate the first candidate</span>
</span><span class='line'>      <span class="vi">@next</span> <span class="o">=</span> <span class="mi">9</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Primes must be a number ending in 1, 3, 7 or 9... a bit of reflection will make it clear why</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">each</span>
</span><span class='line'>      <span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>        <span class="vi">@next</span> <span class="o">+=</span> <span class="p">(</span><span class="vi">@next</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">?</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>        <span class="k">yield</span> <span class="vi">@next</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Controller</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="vi">@models</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">idx</span><span class="o">|</span>
</span><span class='line'>        <span class="n">model</span> <span class="o">=</span> <span class="no">Actors</span><span class="o">.</span><span class="n">actorOf</span> <span class="p">{</span> <span class="ss">Sieve</span><span class="p">:</span><span class="ss">:Model</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">model</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>        <span class="n">model</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Seed models with a few initial values... just to get things going</span>
</span><span class='line'>      <span class="vi">@seeds</span> <span class="o">=</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="o">]</span>
</span><span class='line'>      <span class="mi">0</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">idx</span><span class="o">|</span> <span class="vi">@models</span><span class="o">[</span><span class="n">idx</span><span class="o">].</span><span class="n">tell</span> <span class="o">[</span><span class="ss">:add</span><span class="p">,</span><span class="vi">@seeds</span><span class="o">[</span><span class="n">idx</span><span class="o">]]</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@candidates</span> <span class="o">=</span> <span class="no">Candidates</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Part of the lifecycle for an Akka actor.  When this actor is shut down</span>
</span><span class='line'>    <span class="c1"># we&#39;ll want to shut down all the models we&#39;re aware of as well</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">postStop</span>
</span><span class='line'>      <span class="vi">@models</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">stop</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">onReceive</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">case</span> <span class="n">msg</span>
</span><span class='line'>      <span class="k">when</span> <span class="ss">:next</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># If we still have seeds to return do so up front</span>
</span><span class='line'>        <span class="n">seed</span> <span class="o">=</span> <span class="vi">@seeds</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">seed</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">getContext</span><span class="o">.</span><span class="n">replySafe</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># If we&#39;re still here then we need to evaluate candidates against our models.  Each</span>
</span><span class='line'>        <span class="c1"># candidate value is fed into the models in parallel.  The first value that all models</span>
</span><span class='line'>        <span class="c1"># agree is prime is returned as the value</span>
</span><span class='line'>        <span class="n">val</span> <span class="o">=</span> <span class="vi">@candidates</span><span class="o">.</span><span class="n">find</span> <span class="k">do</span> <span class="o">|</span><span class="n">candidate</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@models</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">sendRequestReplyFuture</span> <span class="o">[</span><span class="ss">:isprime</span><span class="p">,</span><span class="n">candidate</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">all?</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>            <span class="n">f</span><span class="o">.</span><span class="n">await</span>
</span><span class='line'>            <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">isDefined</span>
</span><span class='line'>            <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Now that we have a prime value we need to update the state of one of our models to</span>
</span><span class='line'>        <span class="c1"># include this new value.  For now we just choose a model at random</span>
</span><span class='line'>        <span class="vi">@models</span><span class="o">[</span><span class="p">(</span><span class="nb">rand</span> <span class="vi">@models</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">].</span><span class="n">tell</span> <span class="o">[</span><span class="ss">:add</span><span class="p">,</span><span class="n">val</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Finally, send a response back to the caller</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">getContext</span><span class="o">.</span><span class="n">replySafe</span> <span class="n">val</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># A model represents a fragment of the state of our sieve, specifically some subset</span>
</span><span class='line'>  <span class="c1"># of the primes discovered so far.</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Model</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="vi">@primes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">onReceive</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># It&#39;s times like this that one really does miss Scala&#39;s pattern matching</span>
</span><span class='line'>      <span class="c1"># but case fills in nicely enough</span>
</span><span class='line'>      <span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">msg</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">type</span>
</span><span class='line'>      <span class="k">when</span> <span class="ss">:add</span>
</span><span class='line'>        <span class="vi">@primes</span> <span class="o">&lt;&lt;</span> <span class="n">data</span>
</span><span class='line'>      <span class="k">when</span> <span class="ss">:isprime</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># If we haven&#39;t been fed any primes yet we can&#39;t say much...</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@primes</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">getContext</span><span class="o">.</span><span class="n">replySafe</span> <span class="kp">nil</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># This model only considers a value prime if it doesn&#39;t divide evenly into any</span>
</span><span class='line'>        <span class="c1"># prime it already knows about.  Of course we have to make an exception if we&#39;re</span>
</span><span class='line'>        <span class="c1"># testing one of the primes we already know about</span>
</span><span class='line'>        <span class="n">resp</span> <span class="o">=</span> <span class="vi">@primes</span><span class="o">.</span><span class="n">none?</span> <span class="k">do</span> <span class="o">|</span><span class="n">prime</span><span class="o">|</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">!=</span> <span class="n">prime</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">%</span> <span class="n">prime</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">getContext</span><span class="o">.</span><span class="n">replySafe</span> <span class="n">resp</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Unknown type </span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby offers a number of features which help us out here. As shown in this implementation messages can be as simple as a list with a leading symbol (used to indicate the message &#8220;type&#8221;) and a payload contained in the remainder of the list. This follows a similar convention found in Erlang, although that language uses tuples rather than lists. Support for destructuring/multiple assignment makes working with these messages quite simple.</p>

<p>Our previous work building actors from code blocks doesn&#8217;t apply here due to an implementation detail so we define both the controller and model actors as distinct classes. As it turns out this change isn&#8217;t much of a problem; we&#8217;re able to implement both classes, a helper Enumerable and a second Enumerable wrapping the controller in less than 140 lines with comments. Full code (including tests) can be found on <a href="https://github.com/heuristicfencepost/sieve_actors">github</a>.</p>

<p>Spend a little time with JRuby and Akka and it becomes clear that they work well together and form a good basis for building concurrent applications in Ruby.</p>

<p>[1] This is a bit of a loaded statement; you will get some parallelism as multiple candidates move through the &#8220;stages&#8221; (i.e. goroutines) of the pipeline. That said, this notion of parallelism applies to the system as a whole. The process of determining whether a single candidate is or is not a prime number is still very sequential.</p>

<p>[2] &#8220;First&#8221; here means nothing more than &#8220;whichever test happens to complete and return a value first&#8221;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/25/musings-on-list-comprehensions-functional-programming-and-python/">Musings on List Comprehensions, Functional Programming and Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-25T12:00:00-06:00" pubdate data-updated="true">Nov 25<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/11/musings-on-list-comprehensions.html">Heuristic Fencepost</a></p>

<p>For simplicity and elegance in your programming constructs the <a href="http://en.wikipedia.org/wiki/List_comprehension">list comprehension</a> is hard to beat. [1] A list comprehension can filter an input list, transform it or do both, all in a single expression and with very readable syntax. At it&#8217;s best a list comprehension is &#8220;beautiful code&#8221; distilled: very clear and expressive with no unnecessary noise. You can, of course, make list comprehensions &#8220;ugly&#8221; but at least you have to try a bit to do so.</p>

<p>List comprehensions have their roots in functional programming and several modern functional languages include support for them. We&#8217;ll see comprehensions in Haskell, Clojure and Scala. [2] Python also includes support for comprehensions; in fact the basis for <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=98196">Guido&#8217;s argument</a> to remove the map and filter functions from py3k was that expressions using these functions could be easily re-written as comprehensions. We also consider comprehensions in Python, including differences between the Python implementation and those in other languages and what effect those differences may have.</p>

<p>Let&#8217;s consider a fairly straightforward problem problem: given a list of (x,y) coordinates in some two-dimensional space provide a list of the coordinates that are within some fixed distance of the origin of (0,0). Our application also requires that results be displayed in <a href="http://en.wikipedia.org/wiki/Polar_coordinates">polar coordinates</a>, so for extra bonus points we should return our results in that notation. We can solve the problem quite easily in Haskell and Clojure using list comprehensions:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">toDegrees</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">toDegrees</span> <span class="n">rad</span> <span class="ow">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>
</span><span class='line'>
</span><span class='line'><span class="nf">euclidean</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">euclidean</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">foo</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>                  <span class="n">bar</span> <span class="ow">=</span> <span class="n">y</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>              <span class="kr">in</span> <span class="n">sqrt</span> <span class="p">(</span><span class="n">foo</span> <span class="o">+</span> <span class="n">bar</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
</span><span class='line'>     <span class="n">print</span> <span class="p">[(</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">,(</span><span class="n">toDegrees</span> <span class="o">.</span> <span class="n">atan</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="ow">&lt;-</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)],(</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">euclidean</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span> <span class="p">(</span><span class="nf">Math/sqrt</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">y</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">for </span><span class="p">[</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">x</span>,<span class="nv">y</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[[</span><span class="mi">1</span>,<span class="mi">2</span><span class="p">]</span>,<span class="p">[</span><span class="mi">2</span>,<span class="mi">3</span><span class="p">]</span>,<span class="p">[</span><span class="mi">3</span>,<span class="mi">4</span><span class="p">]]</span>
</span><span class='line'>      <span class="ss">:when</span> <span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="mf">3.0</span><span class="p">)]</span>
</span><span class='line'>       <span class="p">[(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span>,<span class="p">(</span><span class="nf">Math/toDegrees</span> <span class="p">(</span><span class="nf">Math/atan</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">y</span> <span class="nv">x</span><span class="p">)))]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Scala we use for expressions to accomplish something very similar:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.math.</span><span class="o">{</span><span class="n">atan</span><span class="o">,</span><span class="n">pow</span><span class="o">,</span><span class="n">sqrt</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">),(</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">),(</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">)))</span> <span class="o">&gt;</span> <span class="mf">3.0</span> <span class="o">}</span>
</span><span class='line'>  <span class="k">yield</span> <span class="o">(</span><span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">))),</span><span class="n">toDegrees</span><span class="o">(</span><span class="n">atan</span><span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="n">toFloat</span><span class="o">/</span><span class="n">x</span><span class="o">)))</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, a straightforward solution in Python:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">print</span> <span class="p">[(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that in each of these solutions we&#8217;re doing a bit more work than we need to. Our implementation computes the distance from the origin twice, once when filtering values and again when generating the final output of the transformation process. This seems unnecessary; a better option would be to somehow define this value as intermediate state. This state could then be available to both filter and transform expressions. Haskell and Clojure support the introduction of intermediate bindings in their comprehension syntax:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">toDegrees</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">toDegrees</span> <span class="n">rad</span> <span class="ow">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>
</span><span class='line'>
</span><span class='line'><span class="nf">euclidean</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">euclidean</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">foo</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>                  <span class="n">bar</span> <span class="ow">=</span> <span class="n">y</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>              <span class="kr">in</span> <span class="n">sqrt</span> <span class="p">(</span><span class="n">foo</span> <span class="o">+</span> <span class="n">bar</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
</span><span class='line'>     <span class="n">print</span> <span class="p">[(</span><span class="n">dist</span><span class="p">,(</span><span class="n">toDegrees</span> <span class="o">.</span> <span class="n">atan</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="ow">&lt;-</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)],</span><span class="kr">let</span> <span class="n">dist</span><span class="ow">=</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">,</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">euclidean</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span> <span class="p">(</span><span class="nf">Math/sqrt</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">y</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">for </span><span class="p">[</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">x</span>,<span class="nv">y</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[[</span><span class="mi">1</span>,<span class="mi">2</span><span class="p">]</span>,<span class="p">[</span><span class="mi">2</span>,<span class="mi">3</span><span class="p">]</span>,<span class="p">[</span><span class="mi">3</span>,<span class="mi">4</span><span class="p">]]</span>
</span><span class='line'>      <span class="ss">:let</span> <span class="p">[</span><span class="nv">dist</span> <span class="p">(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)]</span>
</span><span class='line'>       <span class="ss">:when</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">dist</span> <span class="mf">3.0</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">[</span><span class="nv">dist</span>,<span class="p">(</span><span class="nf">Math/toDegrees</span> <span class="p">(</span><span class="nf">Math/atan</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">y</span> <span class="nv">x</span><span class="p">)))]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Scala also allows for intermediate bindings within a for expression:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.math.</span><span class="o">{</span><span class="n">atan</span><span class="o">,</span><span class="n">pow</span><span class="o">,</span><span class="n">sqrt</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">),(</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">),(</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="n">dist</span> <span class="k">=</span> <span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">)))</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span> <span class="o">}</span>
</span><span class='line'>  <span class="k">yield</span> <span class="o">(</span><span class="n">dist</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">(</span><span class="n">atan</span><span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="n">toFloat</span><span class="o">/</span><span class="n">x</span><span class="o">)))</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about Python? It turns out we cannot solve this problem in Python using a single comprehension; the syntax doesn&#8217;t allow for the introduction of intermediate state which can be used in either the predicate or transform expression. On the face of it this seems a bit odd; the language encourages the use of comprehensions for filtering and/or transformation while providing a less robust version of that very construct. To some degree this discrepancy reflects differing language goals. Guido&#8217;s post on the history of list comprehensions seems to indicate that the motivation for adding these features was pragmatic; the syntax is an elegant way to express most filter and transform operations. Functional languages use list comprehensions as &#8220;syntactic sugar&#8221; for monadic effects [3] that don&#8217;t really have an equivalent in standard Python usage. The syntax may look the same, but if you&#8217;re coming from a functional perspective they can feel just a bit off. The same is true for a few other common functional idioms:</p>

<ul>
<li>Lazy evaluation - List comprehensions in Python are not lazily evaluated. Generator expressions, which look very similar to list comprehensions, are lazily evaluated.</li>
<li>Higher-order functions - Anonymous functions are supported in Python but these functions are famously limited to a single expression. Functions can return functions but for non-trivial functions a named function must be declared and returned.</li>
</ul>


<p>A couple things should be noted here. First, let us clearly state that Python is not and does not claim to be a functional programming language. While absolutely true, this fact doesn&#8217;t change the underlying point. Moving from functional concepts back into Python can be a bit jarring; some things look similar but don&#8217;t behave quite like you&#8217;d expect.</p>

<p>It&#8217;s also worth noting that the inability to solve this problem with list comprehensions in Python doesn&#8217;t mean that this problem cannot be solved in idiomatic Python. We wish to return our intermediate state as well as filter results based on it&#8217;s value; this dual use allows us to solve the problem with nested comprehensions. The inner comprehension will generate the final representation (including the intermediate state) and the outer comprehension will filter results based on that representation. In Python this looks something like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">print</span> <span class="p">[(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span> <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works only because the intermediate state is also returned in the final result. If that state were not explicitly returned (i.e. if it&#8217;s values were used as input to a conditional expression which returned, say, a string value describing the distance) this solution would not apply.</p>

<p>We can also solve this problem using generators. Using the state maintained by the generator we can iterate through the list, compute the intermediate state and yield a value only when we&#8217;ve satisfied our predicate. A generator-based solution would look something like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">def</span> <span class="nf">somefunc</span><span class="p">(</span><span class="n">alist</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">:</span>
</span><span class='line'>    <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">):</span>
</span><span class='line'>            <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span>
</span><span class='line'><span class="k">print</span> <span class="nb">list</span><span class="p">(</span><span class="n">somefunc</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, none of these comments should be construed as a criticism of Python, the design choices that went into the language or the inclusion of list comprehensions generally. The pragmatic case for inclusion of this feature seems very strong. This post is interested only in the interplay between these features and similar features in other languages.</p>

<p>[1] Some languages (perhaps most notably Scala) use the term &#8220;for comprehension&#8221; or &#8220;for expression&#8221;, and in some of these languages (Scala again) these constructs are more flexible than a list comprehension. That said, it&#8217;s fairly straightforward to make Scala&#8217;s for expressions behave like conventional list comprehensions.</p>

<p>[2] A purist might object that Scala is designed to mix features of object-oriented and functional languages, but the bias in favor of functional constructs justifies Scala&#8217;s inclusion here.</p>

<p>[3] As an example, note that in Haskell list comprehensions can be replaced with do-notation. See the Haskell wiki for details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/12/ruby-and-concurrency-the-mechanics-of-akka-and-jruby/">Ruby and Concurrency: The Mechanics of Akka and JRuby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-12T12:00:00-05:00" pubdate data-updated="true">Sep 12<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/09/ruby-and-concurrency-mechanics-of-akka.html">Heuristic Fencepost</a></p>

<p>I&#8217;m interested in concurrency. I&#8217;m also interested in Ruby. There doesn&#8217;t seem to be much reason to keep these two guys apart anymore.</p>

<p>This post marks the beginning of an occasional series on the topic of using Ruby to write concurrent code. Ruby doesn&#8217;t yet have a big reputation in the world of concurrent and/or parallel applications, but there is some interesting work being done in this space. And since problems in concurrency are notoriously difficult to reason about we could probably do a lot worse than attempt to address those problems in a language designed to make life easier for the developer.</p>

<p>We begin with <a href="http://akka.io">Akka</a>, an excellent library designed to bring actors, actor coordination and STM to Scala and, to a slightly lesser degree, the JVM generally. Our initial task is simple: we wish to be able to define an Akka actor by providing a message handler as a code block. We&#8217;ll start by attempting to implement the actor as a standalone class and then abstract that solution into code which requires the input block and nothing else.</p>

<p>A simple initial implementation looks something like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;akka-actor-1.2-RC6.jar&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;scala-library.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActor&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.Actors&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Start with something simple.  Implement the actor as a distinct</span>
</span><span class='line'><span class="c1"># class and start it up within the Akka runtime.</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Look, I&#39;ve implemented the actor API!</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActor</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">onReceive</span> <span class="n">msg</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Received message: </span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># So we should be fine then, right?</span>
</span><span class='line'><span class="n">ref</span> <span class="o">=</span> <span class="no">Actors</span><span class="o">.</span><span class="n">actorOf</span> <span class="no">SomeActor</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">tell</span> <span class="s2">&quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[@varese ruby]$ ruby --version
jruby 1.6.2 (ruby-1.8.7-p330) (2011-05-23 e2ea975) (OpenJDK Client VM 1.6.0_22) [linux-i386-java]
[@varese ruby]$ ruby akka_sample1.rb 
ArgumentError: Constructor invocation failed: ActorRef for instance of actor [org.jruby.proxy.akka.actor.UntypedActor$Proxy0] is not in scope.
 You can not create an instance of an actor explicitly using 'new MyActor'.
 You have to use one of the factory methods in the 'Actor' object to create a new actor.
 Either use:
  'val actor = Actor.actorOf[MyActor]', or
  'val actor = Actor.actorOf(new MyActor(..))'
  (root) at akka_sample1.rb:20
</code></pre>

<p>Well, that didn&#8217;t work very well. Apparently the class we defined in JRuby is being exposed to the Java lib as a proxy object and that proxy&#8217;s class is unknown to the Akka runtime. No problem; Akka supports a factory model for actor creation, and by using that approach the underlying class of our actor should become a non-issue. With a few simple changes we&#8217;re ready to try again:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;akka-actor-1.2-RC6.jar&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;scala-library.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActor&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.Actors&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># A second attempt.  Define our actor in a standlone class again</span>
</span><span class='line'><span class="c1"># but this time use an ActorFactory (via closure coercion) to</span>
</span><span class='line'><span class="c1"># interact with Akka.</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define our actor in a class again...</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActor</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">onReceive</span> <span class="n">msg</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Received message: </span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ... and then provide an UntypedActorFactory to instantiate</span>
</span><span class='line'><span class="c1"># the actor.  The factory interface qualifies as a SAM so</span>
</span><span class='line'><span class="c1"># we only need to provide a closure to generate the actor and</span>
</span><span class='line'><span class="c1"># let JRuby&#39;s closure coercion handle the rest.</span>
</span><span class='line'><span class="n">ref</span> <span class="o">=</span> <span class="no">Actors</span><span class="o">.</span><span class="n">actorOf</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">SomeActor</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">tell</span> <span class="s2">&quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[@varese ruby]$ ruby akka_sample2.rb
Received message: foo
</code></pre>

<p>We now have a working actor, but we still have some work to do; remember, we want to be able to define arbitrary actors by supplying just a code block. We need a few additional pieces to make this work:</p>

<ul>
<li>A generic actor implementation whose state includes a block or Proc instance. The onReceive method of this actor could then simply call the contained block/Proc, passing the input message as an arg.</li>
<li>An ActorFactory implementation which takes a code block as an arg, stores it in internal state and then uses that block to build an instance of the generic actor described above on demand.</li>
</ul>


<p>A first cut at this concept might look something like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;akka-actor-1.2-RC6.jar&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;scala-library.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActor&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActorFactory&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.Actors&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Shift to working with code blocks via a generic actor and a simple</span>
</span><span class='line'><span class="c1"># factory for creating them.</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActor</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Look, I&#39;ve got a constructor... but it&#39;ll get ignored!</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">proc</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span> <span class="o">=</span> <span class="nb">proc</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">onReceive</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span><span class="o">.</span><span class="n">call</span> <span class="n">msg</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActorFactory</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">UntypedActorFactory</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span> <span class="o">=</span> <span class="n">b</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="no">SomeActor</span><span class="o">.</span><span class="n">new</span> <span class="vi">@proc</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Create a factory for an actor that uses the input block to pass incoming messages.</span>
</span><span class='line'><span class="n">factory</span> <span class="o">=</span> <span class="no">SomeActorFactory</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Message recieved: </span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">ref</span> <span class="o">=</span> <span class="no">Actors</span><span class="o">.</span><span class="n">actorOf</span> <span class="n">factory</span>
</span><span class='line'>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">tell</span> <span class="s2">&quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[@varese ruby]$ ruby akka_sample3.rb 
ArgumentError: wrong number of arguments for constructor
  create at akka_sample3.rb:29
  (root) at akka_sample3.rb:37
</code></pre>

<p>What went wrong here? UntypedActor is a concrete class with a defined no-arg constructor. That constructor is being called in favor of the one we&#8217;ve provided, and as a consequence our block never gets into the mix. There&#8217;s almost certainly a cleaner way to solve this using JRuby, but for the moment we can get around the problem (in an admittedly ugly way) by providing a setter on our generic actor class:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;akka-actor-1.2-RC6.jar&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;scala-library.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActor&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.UntypedActorFactory&#39;</span>
</span><span class='line'><span class="n">java_import</span> <span class="s1">&#39;akka.actor.Actors&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Continue with the generic actor implementation, but shift to using a setter</span>
</span><span class='line'><span class="c1"># for passing in the Proc to which we&#39;ll delegate message handling.</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActor</span> <span class="o">&lt;</span> <span class="no">UntypedActor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">proc</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span> <span class="o">=</span> <span class="n">b</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">onReceive</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span><span class="o">.</span><span class="n">call</span> <span class="n">msg</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SomeActorFactory</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">UntypedActorFactory</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@proc</span> <span class="o">=</span> <span class="n">b</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">rv</span> <span class="o">=</span> <span class="no">SomeActor</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">rv</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="vi">@proc</span>
</span><span class='line'>    <span class="n">rv</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Create a factory for an actor that uses the input block to pass incoming messages.</span>
</span><span class='line'><span class="n">factory</span> <span class="o">=</span> <span class="no">SomeActorFactory</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Message recieved: </span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">ref</span> <span class="o">=</span> <span class="no">Actors</span><span class="o">.</span><span class="n">actorOf</span> <span class="n">factory</span>
</span><span class='line'>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">ref</span><span class="o">.</span><span class="n">tell</span> <span class="s2">&quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[@varese ruby]$ ruby akka_sample4.rb 
Message recieved: foo
</code></pre>

<p>We now have what we wanted.</p>

<p>If you&#8217;re interested in this topic note that Nick Sieger has covered similar ground (including the interaction between JRuby and Akka) <a href="http://blog.engineyard.com/2011/concurrency-in-jruby">here</a>. Nick&#8217;s article draws on some <a href="http://metaphysicaldeveloper.wordpress.com/2010/12/16/high-level-concurrency-with-jruby-and-akka-actors/">very good work</a> done by Daniel Ribeiro late last year. The code referenced in Daniel&#8217;s article is <a href="https://github.com/danielribeiro/RubyOnAkka">available</a> on Github. I didn&#8217;t come across Daniel&#8217;s post until my own was nearly done but there is quite a bit of overlap between his code and mine. That said, I recommend taking a look at both articles, if for no other reason than the fact that both authors are much better at writing Ruby code than I am.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/02/cassandra-and-clojure-things-to-bytes-and-back-again/">Cassandra and Clojure: Things to Bytes and Back Again</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-02T12:00:00-05:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/09/cassandra-and-clojure-things-to-bytes.html">Heuristic Fencepost</a></p>

<p>In a <a href="http://absurdfarce.github.io/blog/2011/05/24/cassandra-and-clojure-the-beginning-of-a-beautiful-friendship/">previous post</a> we briefly discussed the idea of using idiomatic Clojure to access data contained in a Cassandra instance, including transparent conversion to and from Clojure data. We&#8217;ll explore an implementation of this idea, although we won&#8217;t address the question of laziness, in part because there are sizable trade-offs to consider. For example, any solution that provides lazy evaluation must do so while also attempting to minimize the number of trips to the underlying data store. This question may be picked up in yet more future work, but for now we&#8217;ll continue on. We&#8217;ve upgraded to Cassandra 0.8.2 and Clojure 1.2, and we&#8217;re using a new data model (see below), but for the most part we&#8217;ll try to pick up where we left off.</p>

<p>At the core the Cassandra data model is centered around columns. Each of these columns contains both a name and a value, both of which are represented as binary data. This model is very simple, and while it may appear limiting it is in reality quite flexible. The lack of any pre-defined data types avoids any &#8220;impedance mismatch&#8221; resulting from structured data being shoehorned into data types that don&#8217;t really fit. We&#8217;re free to represent column values in any way we see fit; if we can convert it into bytes it&#8217;s fair game. Our problem thus devolves into a question of serialization, and suddenly there are many suitors vying for our attention. Among the set of well-known serialization packages we find Google&#8217;s <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>, <a href="http://thrift.apache.org">Thrift</a> and <a href="http://avro.apache.org">Avro</a>. And since we&#8217;re working in a language with good Java interop we can always have Java&#8217;s built-in serialization (or something similar like <a href="http://code.google.com/p/kryo">Kryo</a>) available. Finally we&#8217;re always free to roll our own.</p>

<p>Let&#8217;s begin by ruling out that last idea. There are already well-tested third-party serialization libraries so unless we believe that all of them suffer from some fatal error it&#8217;s difficult to justify the risk and expense of creating something new.  We&#8217;d also like our approach to have some level of cross-platform support so native Java serialization is excluded (along with Kryo). We also need to be able to encode and decode arbitrary data without defining message types or their payload(s) in advance, a limitation that rules out Protocol Buffers and Thrift. The last man standing is Avro, and fortunately for us he&#8217;s a good candidate. Avro is schema-based but the library includes facilities for generating schemas on the fly by inspecting objects via Java reflection. Also included is a notion of storing schemas with data, allowing the original object to be easily reconstructed as needed. The Avro <a href="http://avro.apache.org/docs/current/spec.html">data model</a> includes a rich set of basic types as well as support for &#8220;complex&#8221; types such as arrays and maps.</p>

<p>We&#8217;ll need to implement a Clojure interface into the Avro functionality; this can be as simple as methods to encode and decode data and schemas. At least some implementations of Avro data files use a pre-defined &#8220;meta-schema&#8221; (consisting of the schema for the embedded data and that data itself) for storing both items. Consumers of these files first decode the meta-schema then use the discovered schema to decode the underlying data. We&#8217;ll follow a similar path for our library. We&#8217;ll also extend our Cassandra support a bit in order to support the insertion of new columns for a given key and column family.</p>

<p>We wind up with the following for our Avro library:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">fencepost.avro</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; Dependencies</span>
</span><span class='line'><span class="c1">; avro 1.5.2</span>
</span><span class='line'><span class="c1">; paranamer 2.0 (required by Avro)</span>
</span><span class='line'><span class="c1">; jackson 1.8.5 (required by Avro)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.avro</span> <span class="nv">Schema</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.avro.generic</span> <span class="nv">GenericDatumReader</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.avro.io</span> <span class="nv">BufferedBinaryEncoder</span> <span class="nv">EncoderFactory</span> <span class="nv">DecoderFactory</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.avro.reflect</span> <span class="nv">ReflectData</span> <span class="nv">ReflectDatumWriter</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">java.io</span> <span class="nv">ByteArrayOutputStream</span> <span class="nv">ByteArrayInputStream</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get_meta_schema</span> <span class="p">[]</span>
</span><span class='line'>      <span class="c1">; Ideally we&#39;d use a record for this sort of thing but doing so would require setX()</span>
</span><span class='line'>      <span class="c1">; accessors for all fields.  Use of a map here is less precise but quite a bit easier</span>
</span><span class='line'>      <span class="c1">; to code.</span>
</span><span class='line'>      <span class="s">&quot;{\&quot;type\&quot;: \&quot;map\&quot;, \&quot;values\&quot;: \&quot;bytes\&quot;}&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">encode_with_schema</span> <span class="p">[</span><span class="nv">target</span><span class="p">]</span>
</span><span class='line'>      <span class="s">&quot;Use Java reflection to generate a schema for the input object and return that schema along with encoded data&quot;</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">targetschema</span> <span class="p">(</span><span class="nf">.getSchema</span> <span class="p">(</span><span class="nf">ReflectData/get</span><span class="p">)</span> <span class="p">(</span><span class="nf">.getClass</span> <span class="nv">target</span><span class="p">))</span>
</span><span class='line'>              <span class="nv">targetwriter</span> <span class="p">(</span><span class="nf">ReflectDatumWriter.</span> <span class="nv">targetschema</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">buffer</span> <span class="p">(</span><span class="nf">ByteArrayOutputStream.</span><span class="p">)</span>
</span><span class='line'>              <span class="nv">encoder</span> <span class="p">(</span><span class="nf">.binaryEncoder</span> <span class="p">(</span><span class="nf">EncoderFactory.</span><span class="p">)</span> <span class="nv">buffer</span> <span class="nv">nil</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">; Populate the buffer with Avro data for the target.  Note that we can&#39;t bundle the</span>
</span><span class='line'>      <span class="c1">; whole thing up into a single let expression because of our reliance on side effects.</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.write</span> <span class="nv">targetwriter</span> <span class="nv">target</span> <span class="nv">encoder</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.flush</span> <span class="nv">encoder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">targetdata</span> <span class="p">(</span><span class="nf">.toByteArray</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">metawriter</span> <span class="p">(</span><span class="nf">ReflectDatumWriter.</span> <span class="p">(</span><span class="nf">Schema/parse</span> <span class="p">(</span><span class="nf">get_meta_schema</span><span class="p">)))]</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.reset</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.write</span> <span class="nv">metawriter</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;schema&quot;</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="p">(</span><span class="nf">.toString</span> <span class="nv">targetschema</span><span class="p">))</span> <span class="s">&quot;data&quot;</span> <span class="nv">targetdata</span><span class="p">}</span>
</span><span class='line'>            <span class="nv">encoder</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.flush</span> <span class="nv">encoder</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.toByteArray</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">decode_from_schema</span> <span class="p">[</span><span class="nv">indata</span><span class="p">]</span>
</span><span class='line'>      <span class="s">&quot;Use the meta_schema to extract data and schema and then extract raw data&quot;</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">metareader</span> <span class="p">(</span><span class="nf">GenericDatumReader.</span> <span class="p">(</span><span class="nf">Schema/parse</span> <span class="p">(</span><span class="nf">get_meta_schema</span><span class="p">)))</span>
</span><span class='line'>              <span class="nv">buffer</span> <span class="p">(</span><span class="nf">ByteArrayInputStream.</span> <span class="nv">indata</span><span class="p">)</span>
</span><span class='line'>              <span class="nv">decoder</span> <span class="p">(</span><span class="nf">.binaryDecoder</span> <span class="p">(</span><span class="nf">DecoderFactory.</span><span class="p">)</span> <span class="nv">buffer</span> <span class="nv">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">middata</span> <span class="p">(</span><span class="nf">.read</span> <span class="nv">metareader</span> <span class="nv">nil</span> <span class="nv">decoder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">; The data type returned from the underlying Avro Java code needs a bit</span>
</span><span class='line'>      <span class="c1">; of massaging before we can move forward.  Avro decoders return strings</span>
</span><span class='line'>      <span class="c1">; as instances of Utf8 objects so we have to apply &quot;str&quot; to them directly</span>
</span><span class='line'>      <span class="c1">; in order to get back something we can work with.</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">schema</span> <span class="s">&quot;schema&quot;</span> <span class="nv">data</span> <span class="s">&quot;data&quot;</span><span class="p">}</span> <span class="p">(</span><span class="nb">zipmap </span><span class="p">(</span><span class="nb">map str </span><span class="p">(</span><span class="nb">keys </span><span class="nv">middata</span><span class="p">))</span> <span class="p">(</span><span class="nb">vals </span><span class="nv">middata</span><span class="p">))</span>
</span><span class='line'>      <span class="nv">schemabytes</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="p">(</span><span class="nf">.capacity</span> <span class="nv">schema</span><span class="p">))</span>
</span><span class='line'>      <span class="nv">databytes</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="p">(</span><span class="nf">.capacity</span> <span class="nv">data</span><span class="p">))]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">; Ah, more side effects.  The Java Avro implementation makes heavy use of</span>
</span><span class='line'>      <span class="c1">; NIO ByteBuffers, so we&#39;re forced to convert them into byte arrays before</span>
</span><span class='line'>      <span class="c1">; continuing. </span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.get</span> <span class="nv">schema</span> <span class="nv">schemabytes</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.get</span> <span class="nv">data</span> <span class="nv">databytes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">targetreader</span> <span class="p">(</span><span class="nf">GenericDatumReader.</span> <span class="p">(</span><span class="nf">Schema/parse</span> <span class="p">(</span><span class="nf">String.</span> <span class="nv">schemabytes</span><span class="p">)))</span>
</span><span class='line'>           <span class="nv">targetdecoder</span> <span class="p">(</span><span class="nf">.binaryDecoder</span> <span class="p">(</span><span class="nf">DecoderFactory.</span><span class="p">)</span> <span class="nv">databytes</span> <span class="nv">nil</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">.read</span> <span class="nv">targetreader</span> <span class="nv">nil</span> <span class="nv">targetdecoder</span><span class="p">)</span>
</span><span class='line'>       <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>After the improvements described above our Cassandra library now looks like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">fencepost.cassandra</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; Dependencies</span>
</span><span class='line'><span class="c1">; apache-cassandra-thrift-0.8.2.jar</span>
</span><span class='line'><span class="c1">; libthrift-0.6.jar</span>
</span><span class='line'><span class="c1">; slf4j-api-1.6.1.jar</span>
</span><span class='line'><span class="c1">; slf4j-log4j12-1.6.1.jar</span>
</span><span class='line'><span class="c1">; log4j-1.2.16.jar</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.cassandra.thrift</span> <span class="nv">Cassandra$Client</span> <span class="nv">SliceRange</span> <span class="nv">SlicePredicate</span> <span class="nv">ColumnParent</span> <span class="nv">KeyRange</span> <span class="nv">ConsistencyLevel</span> <span class="nv">ColumnPath</span> <span class="nv">Column</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.transport</span> <span class="nv">TFramedTransport</span> <span class="nv">TSocket</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.protocol</span> <span class="nv">TBinaryProtocol</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">java.nio</span> <span class="nv">ByteBuffer</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; A quick note on usage.  The Cassandra Java API returns &quot;this&quot; for many of the setX() methods on the setters of core objects in the Thrift</span>
</span><span class='line'><span class="c1">; API.  Our usage here consistently employs the doto syntax rather than relying on these return values.  This is largely a matter of </span>
</span><span class='line'><span class="c1">; convention, but in this case it appears to make the code a bit clearer to read.  Your mileage may vary.</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">connect</span> <span class="p">[</span><span class="nv">host</span> <span class="nv">port</span> <span class="nv">keyspace</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Connect to a Cassandra instance on the specified host and port.  Set things up to use the specified key space.&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">transport</span> <span class="p">(</span><span class="nf">TFramedTransport.</span> <span class="p">(</span><span class="nf">TSocket.</span> <span class="nv">host</span> <span class="nv">port</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">protocol</span> <span class="p">(</span><span class="nf">TBinaryProtocol.</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">client</span> <span class="p">(</span><span class="nf">Cassandra$Client.</span> <span class="nv">protocol</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.open</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.set_keyspace</span> <span class="nv">client</span> <span class="nv">keyspace</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">client</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get_range_slices</span> <span class="p">[</span><span class="nv">client</span> <span class="nv">cf</span> <span class="nv">start</span> <span class="nv">end</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Get a list of KeySlices for every key in the range beginning with start and ending with end&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">slice_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SliceRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setFinish</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setReversed</span> <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setCount</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="nv">slice_predicate</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SlicePredicate.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setSlice_range</span> <span class="nv">slice_range</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">column_parent</span> <span class="p">(</span><span class="nf">ColumnParent.</span> <span class="nv">cf</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">key_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">KeyRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">start</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setEnd_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">end</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.get_range_slices</span> <span class="nv">client</span> <span class="nv">column_parent</span> <span class="nv">slice_predicate</span> <span class="nv">key_range</span> <span class="nv">ConsistencyLevel/ONE</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_keys</span> <span class="p">[</span><span class="nv">slices</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Retrieve the set of keys in a list of KeySlices&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">slices</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_columns</span> <span class="p">[</span><span class="nv">slices</span> <span class="nv">key</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Given a list of KeySlices retrieve a map of the columns associated with the specified key&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">match</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">= key </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">slices</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cond </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">match</span><span class="p">)</span> <span class="nv">nil</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">true? </span><span class="nv">true</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">urcols</span> <span class="p">(</span><span class="nf">.getColumns</span> <span class="nv">match</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">cols</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">.getColumn</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">urcols</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">zipmap </span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getName</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">cols</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">.getValue</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">cols</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">insert</span> <span class="p">[</span><span class="nv">client</span> <span class="nb">key </span><span class="nv">cf</span> <span class="nv">colname</span> <span class="nv">colval_bytes</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Insert the specified column into the specified column family.  At present we don&#39;t support super columns&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">key_bytes</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">key</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">key_buffer</span> <span class="p">(</span><span class="nf">ByteBuffer/allocate</span> <span class="p">(</span><span class="nb">alength </span><span class="nv">key_bytes</span><span class="p">))</span>
</span><span class='line'>       <span class="nv">column_parent</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">ColumnParent.</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setColumn_family</span> <span class="nv">cf</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>       <span class="nv">colname_bytes</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">colname</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">column</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">Column.</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setName</span> <span class="nv">colname_bytes</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setValue</span> <span class="nv">colval_bytes</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setTimestamp</span> <span class="p">(</span><span class="nf">System/currentTimeMillis</span><span class="p">))</span>
</span><span class='line'>  <span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">; Populate the built ByteBuffer with the contents of the input key</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">.put</span> <span class="nv">key_buffer</span> <span class="nv">key_bytes</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">.flip</span> <span class="nv">key_buffer</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">(</span><span class="nf">.insert</span> <span class="nv">client</span> <span class="nv">key_buffer</span> <span class="nv">column_parent</span> <span class="nv">column</span> <span class="nv">ConsistencyLevel/ONE</span><span class="p">)</span>
</span><span class='line'>       <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our core example will be built around a collection of employee records. We want to create a report on these employees using attributes defined in various well-known columns. We&#8217;d like to access the values in these columns as simple data types (booleans, integers, perhaps even an array or a map) but we&#8217;d like to do so through a uniform interface. We don&#8217;t want to access certain columns in certain ways, as if we &#8220;knew&#8221; that a specific column contained data of a specific type. Any such approach is by definition brittle if the underlying data model should shift in flight (as data models are known to do).</p>

<p>After finishing up with our Clojure libraries we implement a simple app for populating our Cassandra instance with randomly-generated employee information:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">; Populate data for a set of random users to a Cassandra instance.</span>
</span><span class='line'><span class="c1">;</span>
</span><span class='line'><span class="c1">; Users consist of the following set of data:</span>
</span><span class='line'><span class="c1">; - a username [String]</span>
</span><span class='line'><span class="c1">; - a user ID [integer]</span>
</span><span class='line'><span class="c1">; - a flag indicating whether the user is &quot;active&quot; [boolean]</span>
</span><span class='line'><span class="c1">; - a list of location IDs for each user [list of integer]</span>
</span><span class='line'><span class="c1">;</span>
</span><span class='line'><span class="c1">; User records are keyed by username rather than user IDs, mainly because at the moment </span>
</span><span class='line'><span class="c1">; we only support strings for key values.  The Cassandra API exposes keys as byte arrays </span>
</span><span class='line'><span class="c1">; so we could extend our Cassandra support to include other datatypes.</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">fencepost.avro</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">fencepost.cassandra</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.commons.lang3</span> <span class="nv">RandomStringUtils</span><span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nf">java.util</span> <span class="nv">Random</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">; Utility function to combine our Avro lib with our Cassandra lib</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add_user</span> <span class="p">[</span><span class="nv">client</span> <span class="nv">username</span> <span class="nv">userid</span> <span class="nv">active</span> <span class="nv">locationids</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">userid_data</span> <span class="p">(</span><span class="nf">encode_with_schema</span> <span class="nv">userid</span><span class="p">)</span>
</span><span class='line'>              <span class="nv">active_data</span> <span class="p">(</span><span class="nf">encode_with_schema</span> <span class="nv">active</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">locationids_data</span> <span class="p">(</span><span class="nf">encode_with_schema</span> <span class="nv">locationids</span><span class="p">)]</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">insert</span> <span class="nv">client</span> <span class="nv">username</span> <span class="s">&quot;employee&quot;</span> <span class="s">&quot;userid&quot;</span> <span class="nv">userid_data</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">insert</span> <span class="nv">client</span> <span class="nv">username</span> <span class="s">&quot;employee&quot;</span> <span class="s">&quot;active&quot;</span> <span class="nv">active_data</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">insert</span> <span class="nv">client</span> <span class="nv">username</span> <span class="s">&quot;employee&quot;</span> <span class="s">&quot;locationids&quot;</span> <span class="nv">locationids_data</span><span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; Generate a list of random usernames</span>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">client</span> <span class="p">(</span><span class="nf">connect</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">9160</span> <span class="s">&quot;employees&quot;</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">n</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">username</span> <span class="p">(</span><span class="nf">RandomStringUtils/randomAlphanumeric</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>               <span class="nv">random</span> <span class="p">(</span><span class="nf">Random.</span><span class="p">)</span>
</span><span class='line'>           <span class="nv">userid</span> <span class="p">(</span><span class="nf">.nextInt</span> <span class="nv">random</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>           <span class="nv">active</span> <span class="p">(</span><span class="nf">.nextBoolean</span> <span class="nv">random</span><span class="p">)</span>
</span><span class='line'>           <span class="nv">locationids</span> <span class="p">(</span><span class="nb">into </span><span class="p">[]</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="mi">10</span> <span class="o">#</span><span class="p">(</span><span class="nf">.nextInt</span> <span class="nv">random</span> <span class="mi">100</span><span class="p">)))]</span>
</span><span class='line'>                      <span class="p">(</span><span class="nf">add_user</span> <span class="nv">client</span> <span class="nv">username</span> <span class="nv">userid</span> <span class="nv">active</span> <span class="nv">locationids</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Added user %s: [%s %s %s]&quot;</span> <span class="nv">username</span> <span class="nv">userid</span> <span class="nv">active</span> <span class="nv">locationids</span><span class="p">))</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[varese clojure]$ ~/local/bin/clojure add_employee_data.clj 
Added user gFc0pVnLKPnjrrLx: [158 true [77 73 99 58 31 64 1 37 70 69]]
Added user 5gGh9anHwFINpr5t: [459 true [34 71 28 1 2 84 11 33 37 28]]
Added user pGRMeXBTFoBIWhud: [945 true [45 83 51 45 11 4 80 68 73 27]]
...
</code></pre>

<p>We&#8217;re now ready to create our reporting application. Using Avro and a consistent meta-schema this comes off fairly easily:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">; Retrieve information from the Cassandra database about one of our employees</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">fencepost.avro</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">fencepost.cassandra</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">evaluate_user</span> <span class="p">[</span><span class="nv">slices</span> <span class="nv">username</span><span class="p">]</span>
</span><span class='line'>      <span class="s">&quot;Gather information for the specified user and display a minimal report about them&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">; Note that the code below says nothing about types.  We specify the column names we</span>
</span><span class='line'>      <span class="c1">; wish to access but whatever Cassandra + Avro supplies for the value of that column</span>
</span><span class='line'>      <span class="c1">; is what we get.</span>
</span><span class='line'>     <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">user_data</span> <span class="p">(</span><span class="nf">range_slices_columns</span> <span class="nv">slices</span> <span class="nv">username</span><span class="p">)</span>
</span><span class='line'>             <span class="nv">userid</span> <span class="p">(</span><span class="nf">decode_from_schema</span> <span class="p">(</span><span class="nf">user_data</span> <span class="ss">:userid</span><span class="p">))</span>
</span><span class='line'>             <span class="nv">active</span> <span class="p">(</span><span class="nf">decode_from_schema</span> <span class="p">(</span><span class="nf">user_data</span> <span class="ss">:active</span><span class="p">))</span>
</span><span class='line'>             <span class="nv">locationids</span> <span class="p">(</span><span class="nf">decode_from_schema</span> <span class="p">(</span><span class="nf">user_data</span> <span class="ss">:locationids</span><span class="p">))]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Username: %s&quot;</span> <span class="nv">username</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Userid: %s&quot;</span> <span class="nv">userid</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">userid</span> <span class="mi">0</span><span class="p">)</span> <span class="s">&quot;Userid is greater than zero&quot;</span> <span class="s">&quot;Userid is not greater than zero&quot;</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Active: %s&quot;</span> <span class="nv">active</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="k">if </span><span class="nv">active</span> <span class="s">&quot;User is active&quot;</span> <span class="s">&quot;User is not active&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">; Every user should have at least one location ID.</span>
</span><span class='line'>      <span class="c1">;</span>
</span><span class='line'>      <span class="c1">; Well, they would if we were able to successfully handle an Avro record.</span>
</span><span class='line'>      <span class="c1">;(assert (&gt; (count locationids) 0))</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">client</span> <span class="p">(</span><span class="nf">connect</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">9160</span> <span class="s">&quot;employees&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">key_slices</span> <span class="p">(</span><span class="nf">get_range_slices</span> <span class="nv">client</span> <span class="s">&quot;employee&quot;</span> <span class="s">&quot;!&quot;</span> <span class="s">&quot;~&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">keys </span><span class="p">(</span><span class="nf">range_slices_keys</span> <span class="nv">key_slices</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Found %d users&quot;</span> <span class="p">(</span><span class="nb">count </span><span class="nv">keys</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">n</span> <span class="p">(</span><span class="nb">count </span><span class="nv">keys</span><span class="p">)]</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">evaluate_user</span> <span class="nv">key_slices</span> <span class="p">(</span><span class="nb">nth keys </span><span class="nv">n</span><span class="p">))</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[varese clojure]$ ~/local/bin/clojure get_employee_data.clj 
Found 10 users
Username: 5gGh9anHwFINpr5t
Userid: 459
Userid is greater than zero
Active: true
User is active
...
</code></pre>

<p>And in order to verify our assumptions about simple cross-platform support we create a Ruby version of something very much like our reporting application:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;avro&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;cassandra&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">evaluate_avro_data</span> <span class="n">bytes</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Define the meta-schema</span>
</span><span class='line'>  <span class="n">meta_schema</span> <span class="o">=</span> <span class="ss">Avro</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">map</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">values</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">bytes</span><span class="se">\&quot;</span><span class="s2">}&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Read the meta source and extract the contained data and schema</span>
</span><span class='line'>  <span class="n">meta_datum_reader</span> <span class="o">=</span> <span class="ss">Avro</span><span class="p">:</span><span class="ss">:IO</span><span class="o">::</span><span class="no">DatumReader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">meta_schema</span><span class="p">)</span>
</span><span class='line'>  <span class="n">meta_val</span> <span class="o">=</span> <span class="n">meta_datum_reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="ss">Avro</span><span class="p">:</span><span class="ss">:IO</span><span class="o">::</span><span class="no">BinaryDecoder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">StringIO</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Build a new reader which can handle the indicated schema</span>
</span><span class='line'>  <span class="n">schema</span> <span class="o">=</span> <span class="ss">Avro</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">meta_val</span><span class="o">[</span><span class="s2">&quot;schema&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">datum_reader</span> <span class="o">=</span> <span class="ss">Avro</span><span class="p">:</span><span class="ss">:IO</span><span class="o">::</span><span class="no">DatumReader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</span><span class='line'>  <span class="n">val</span> <span class="o">=</span> <span class="n">datum_reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="ss">Avro</span><span class="p">:</span><span class="ss">:IO</span><span class="o">::</span><span class="no">BinaryDecoder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">StringIO</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">meta_val</span><span class="o">[</span><span class="s2">&quot;data&quot;</span><span class="o">]</span><span class="p">)))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Cassandra</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;employees&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1:9160&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="ss">:employee</span><span class="p">,{</span><span class="ss">:start_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span><span class="ss">:finish_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;~&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">userid</span> <span class="o">=</span> <span class="n">evaluate_avro_data</span> <span class="n">v</span><span class="o">[</span><span class="s2">&quot;userid&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">active</span> <span class="o">=</span> <span class="n">evaluate_avro_data</span> <span class="n">v</span><span class="o">[</span><span class="s2">&quot;active&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">locationids</span> <span class="o">=</span> <span class="n">evaluate_avro_data</span> <span class="n">v</span><span class="o">[</span><span class="s2">&quot;locationids&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Username: </span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">, user ID: </span><span class="si">#{</span><span class="n">userid</span><span class="si">}</span><span class="s2">, active: </span><span class="si">#{</span><span class="n">active</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;User ID </span><span class="si">#{</span><span class="p">(</span><span class="n">userid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="s2">&quot;is&quot;</span> <span class="p">:</span> <span class="s2">&quot;is not&quot;</span><span class="si">}</span><span class="s2"> greater than zero&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;User </span><span class="si">#{</span><span class="n">active</span> <span class="p">?</span> <span class="s2">&quot;is&quot;</span> <span class="p">:</span> <span class="s2">&quot;is not&quot;</span><span class="si">}</span><span class="s2"> active&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Ruby&#39;s much more flexible notion of truthiness makes the tests above somewhat less</span>
</span><span class='line'>  <span class="c1"># compelling.  For extra validation we add the following</span>
</span><span class='line'>  <span class="s2">&quot;Oops, it&#39;s not a number&quot;</span> <span class="k">unless</span> <span class="n">userid</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Fixnum</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>[varese 1.8]$ ruby get_employee_data.rb
Username: 5gGh9anHwFINpr5t, user ID: 459, active: true
User ID is greater than zero
User is active
Username: 76v8iEJcc79Huj9L, user ID: 469, active: false
User ID is greater than zero
User is not active
...
</code></pre>

<p>This code meets our basic requirement, but as always there were a few stumbling blocks along the way. Avro includes strings as a primitive type, but unfortunately the Java API (which we leverage for our Clojure code) returns string instances as a Utf8 type. We can get a java.lang.String from these objects, but unfortunately we need another toString() method call that (logically) is completely unnecessary. We also don&#8217;t fully support complex types. The Avro code maps the Clojure classes representing arrays and maps onto a &#8220;record&#8221; type that includes the various fields exposed via getters. Supporting these types requires the ability to reconstruct the underlying object based on these fields, and doing so reliably is beyond the scope of this work. Finally, we were forced to use Ruby 1.8.x for the Ruby examples since the Avro gem apparently doesn&#8217;t yet support 1.9.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/24/cassandra-and-clojure-the-beginning-of-a-beautiful-friendship/">Cassandra and Clojure: The Beginning of a Beautiful Friendship</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-24T12:00:00-05:00" pubdate data-updated="true">May 24<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/05/cassandra-and-clojure-beginning-of.html">Heuristic Fencepost</a></p>

<p>Soon after I began working with <a href="http://cassandra.apache.org">Cassandra</a> it became clear to me that if you were in the market for a platform for creating applications that interact with this database you could do a lot worse than <a href="http://clojure.org">Clojure</a>. The lack of a query language [1] suggests that filtering and slicing lists of keys and columns might be a fairly common activity for apps powered by Cassandra. And while many languages support the map/filter/reduce paradigm Clojure&#8217;s use of <a href="http://clojure.org/sequences">sequences</a> throughout the core suggest a natural means to integrate this data into the rest of your application.</p>

<p>Cassandra itself provides an <a href="http://wiki.apache.org/cassandra/API">API</a> that uses the <a href="http://thrift.apache.org">Thrift</a> protocol for manipulating data. We&#8217;ll use this interface to implement a simple proof-of-concept application that might serve as a testbed for manipulating data managed by Cassandra in idiomatic Clojure. Note that the Clojure ecosystem already includes several open-source projects that connect Clojure to Cassandra: these include <a href="https://github.com/robertluo/clj-cassandra">clj-cassandra</a> and <a href="https://github.com/pingles/clj-hector">clj-hector</a>, the latter leveraging the <a href="http://hector-client.github.io/hector/build/html/index.html">Hector Java client</a> to do it&#8217;s work. In order to keep things simple we choose to avoid any of these third-party libraries; it&#8217;s not as if the Thrift interface imposes a heavy burden on us. Let&#8217;s see how far we can get with what&#8217;s already in the packaging.</p>

<p>That sounds great&#8230; so what exactly are we trying to do? Beginning with the database generated during our <a href="http://absurdfarce.github.io/blog/2011/03/29/data-models-and-cassandra/">previous work</a> with Cassandra we should be able to access sets of keys within a keyspace and a set of columns for any specific key. These structures should be available for manipulation in idiomatic Clojure as sequences. Ideally these sequences would be at least somewhat lazy and transparently support multiple datatypes. [2]</p>

<p>Using the Thrift interface requires working with a fair number of Java objects representing return types and/or arguments to the various exposed functions. My Clojure isn&#8217;t yet solid enough to hash out Java interop code without flailing a bit so we kick things off with a Scala implementation. This approach allows us to simplify the interop problem without sacrificing the functional approach, all within a language that is by now fairly familiar.</p>

<p>The Scala code includes a fair number of intermediate objects but is otherwise fairly clean:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.cassandra</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.JavaConversions</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.thrift.protocol.TBinaryProtocol</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.thrift.transport._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.cassandra.service._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.cassandra.thrift._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ThriftCassandraClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">connect</span><span class="o">(</span><span class="n">host</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">port</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span><span class="n">keyspace</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Cassandra.Client</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">transport</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TFramedTransport</span><span class="o">(</span><span class="k">new</span> <span class="nc">TSocket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">protocol</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TBinaryProtocol</span><span class="o">(</span><span class="n">transport</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Cassandra</span><span class="o">.</span><span class="nc">Client</span><span class="o">(</span><span class="n">protocol</span><span class="o">)</span>
</span><span class='line'>    <span class="n">transport</span><span class="o">.</span><span class="n">open</span><span class="o">()</span>
</span><span class='line'>    <span class="n">client</span> <span class="n">set_keyspace</span> <span class="n">keyspace</span>
</span><span class='line'>    <span class="n">client</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Execute a range slice query against the specified Cassandra instance.  Method returns</span>
</span><span class='line'>  <span class="c1">// an object suitable for later interrogation by range_slices_keys() or range_slices_columns()</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">get_range_slices</span><span class="o">(</span><span class="n">client</span><span class="k">:</span><span class="kt">Cassandra.Client</span><span class="o">,</span><span class="n">cf</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">start</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">end</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">sliceRange</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SliceRange</span><span class="o">()</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setStart</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setFinish</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setReversed</span> <span class="kc">false</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setCount</span> <span class="mi">100</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">slicePredicate</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SlicePredicate</span><span class="o">()</span>
</span><span class='line'>    <span class="n">slicePredicate</span> <span class="n">setSlice_range</span> <span class="n">sliceRange</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">columnParent</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ColumnParent</span><span class="o">(</span><span class="n">cf</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">keyRange</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">KeyRange</span><span class="o">()</span>
</span><span class='line'>    <span class="n">keyRange</span> <span class="n">setStart_key</span> <span class="o">(</span><span class="n">start</span> <span class="n">getBytes</span><span class="o">)</span>
</span><span class='line'>    <span class="n">keyRange</span> <span class="n">setEnd_key</span> <span class="o">(</span><span class="n">end</span> <span class="n">getBytes</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">javakeys</span> <span class="k">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_range_slices</span><span class="o">(</span><span class="n">columnParent</span><span class="o">,</span><span class="n">slicePredicate</span><span class="o">,</span><span class="n">keyRange</span><span class="o">,</span><span class="nc">ConsistencyLevel</span><span class="o">.</span><span class="nc">ONE</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Return from Thrift Java client is List&lt;KeySlice&gt; so we have to explicitly convert it here</span>
</span><span class='line'>    <span class="nc">JavaConversions</span> <span class="n">asScalaIterable</span> <span class="n">javakeys</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return an Iterable for all keys in an input query state object</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">range_slices_keys</span><span class="o">(</span><span class="n">slices</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">])</span> <span class="k">=</span> <span class="n">slices</span> <span class="n">map</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getKey</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return an Option containing column information for the specified key in the input query</span>
</span><span class='line'>  <span class="c1">// state object.  If the key isn&#39;t found None is returned, otherwise the Option contains a</span>
</span><span class='line'>  <span class="c1">// map of column names to column values.</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">range_slices_columns</span><span class="o">(</span><span class="n">slices</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">],</span> <span class="n">key</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">slices</span> <span class="n">find</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getKey</span><span class="o">())</span> <span class="o">==</span> <span class="n">key</span> <span class="o">}</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">keyval</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="n">urcols</span> <span class="k">=</span> <span class="nc">JavaConversions</span> <span class="n">asScalaIterable</span> <span class="o">(</span><span class="n">keyval</span> <span class="n">getColumns</span><span class="o">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">cols</span><span class="k">:</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Column</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="n">urcols</span> <span class="n">map</span> <span class="o">(</span><span class="k">_</span> <span class="n">getColumn</span><span class="o">)).</span><span class="n">toSeq</span>
</span><span class='line'>        <span class="nc">Some</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="n">cols</span> <span class="n">map</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getName</span><span class="o">()))</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getValue</span><span class="o">()))</span> <span class="o">}</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="n">connect</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">9160</span><span class="o">,</span><span class="s">&quot;twitter&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">slices</span> <span class="k">=</span> <span class="n">get_range_slices</span><span class="o">(</span><span class="n">client</span><span class="o">,</span><span class="s">&quot;authors&quot;</span><span class="o">,</span><span class="s">&quot;!&quot;</span><span class="o">,</span><span class="s">&quot;~&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">fivekeys</span> <span class="k">=</span> <span class="n">range_slices_keys</span><span class="o">(</span><span class="n">slices</span><span class="o">)</span> <span class="n">take</span> <span class="mi">5</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="s">&quot;fivekeys: &quot;</span> <span class="o">+</span> <span class="n">fivekeys</span><span class="o">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">key</span> <span class="k">&lt;-</span> <span class="n">fivekeys</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">range_slices_columns</span><span class="o">(</span><span class="n">slices</span><span class="o">,</span><span class="n">key</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cols</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">println</span><span class="o">(</span>
</span><span class='line'>            <span class="s">&quot;Key &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span>
</span><span class='line'>            <span class="s">&quot;: name =&gt; &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">cols</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">+</span>
</span><span class='line'>            <span class="s">&quot;, following =&gt; &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">cols</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="s">&quot;following&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">))</span>
</span><span class='line'>          <span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Translating this code into Clojure is more straightforward than expected:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.transport</span> <span class="nv">TFramedTransport</span> <span class="nv">TSocket</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.protocol</span> <span class="nv">TBinaryProtocol</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.cassandra.thrift</span> <span class="nv">Cassandra$Client</span> <span class="nv">SliceRange</span> <span class="nv">SlicePredicate</span> <span class="nv">ColumnParent</span> <span class="nv">KeyRange</span> <span class="nv">ConsistencyLevel</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">connect</span> <span class="p">[</span><span class="nv">host</span> <span class="nv">port</span> <span class="nv">keyspace</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Connect to a Cassandra instance on the specified host and port.  Set things up to use the specified key space.&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">transport</span> <span class="p">(</span><span class="nf">TFramedTransport.</span> <span class="p">(</span><span class="nf">TSocket.</span> <span class="nv">host</span> <span class="nv">port</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">protocol</span> <span class="p">(</span><span class="nf">TBinaryProtocol.</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">client</span> <span class="p">(</span><span class="nf">Cassandra$Client.</span> <span class="nv">protocol</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.open</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.set_keyspace</span> <span class="nv">client</span> <span class="nv">keyspace</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">client</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get_range_slices</span> <span class="p">[</span><span class="nv">client</span> <span class="nv">cf</span> <span class="nv">start</span> <span class="nv">end</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Simple front end into the get_range_slices function exposed via Thrift&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">slice_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SliceRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setFinish</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setReversed</span> <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setCount</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="nv">slice_predicate</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SlicePredicate.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setSlice_range</span> <span class="nv">slice_range</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">column_parent</span> <span class="p">(</span><span class="nf">ColumnParent.</span> <span class="nv">cf</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">key_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">KeyRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">start</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setEnd_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">end</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.get_range_slices</span> <span class="nv">client</span> <span class="nv">column_parent</span> <span class="nv">slice_predicate</span> <span class="nv">key_range</span> <span class="nv">ConsistencyLevel/ONE</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_keys</span> <span class="p">[</span><span class="nv">slices</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Retrieve the set of keys in a get_range_slices result&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">slices</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_columns</span> <span class="p">[</span><span class="nv">slices</span> <span class="nv">key</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Retrieve a map of the columns associated with the specified key in a get_range_slices result&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">match</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">= key </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">slices</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cond </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">match</span><span class="p">)</span> <span class="nv">nil</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">true? </span><span class="nv">true</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">urcols</span> <span class="p">(</span><span class="nf">.getColumns</span> <span class="nv">match</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">cols</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">.getColumn</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">urcols</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">zipmap </span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getName</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">cols</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getValue</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">cols</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">client</span> <span class="p">(</span><span class="nf">connect</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">9160</span> <span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">key_slices</span> <span class="p">(</span><span class="nf">get_range_slices</span> <span class="nv">client</span> <span class="s">&quot;authors&quot;</span> <span class="s">&quot;!&quot;</span> <span class="s">&quot;~&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">five_keys</span> <span class="p">(</span><span class="nb">take </span><span class="mi">5</span> <span class="p">(</span><span class="nf">range_slices_keys</span> <span class="nv">key_slices</span><span class="p">))]</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="nb">print </span><span class="nv">five_keys</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">formatfn</span>
</span><span class='line'>        <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cols</span> <span class="p">(</span><span class="nf">range_slices_columns</span> <span class="nv">key_slices</span> <span class="nv">key</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Key %s: name =&gt; %s, following =&gt; %s\n&quot;</span> <span class="nb">key </span><span class="p">(</span><span class="nf">cols</span> <span class="ss">:name</span><span class="p">)</span> <span class="p">(</span><span class="nf">cols</span> <span class="ss">:following</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">print </span><span class="p">(</span><span class="nb">reduce str </span><span class="p">(</span><span class="nb">map </span><span class="nv">formatfn</span> <span class="nv">five_keys</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>These results seem fairly promising, although we&#8217;re nowhere near done. This code assumes that all column names and values are strings, a perfectly ridiculous assumption. We also don&#8217;t offer any support for nested data types, although in fairness this was a failing of our earlier work as well. Finally we haven&#8217;t built in much support for lazy evaluation; we lazily convert column names to Clojure keywords but that&#8217;s about it. But fear not, gentle reader; we&#8217;ll revisit some or all of these points in future work.</p>

<p>[1] At least until <a href="https://issues.apache.org/jira/browse/CASSANDRA-1703">CQL</a> arrives in Cassandra 0.8</p>

<p>[2] We won&#8217;t be able to meet these last two goals in our initial implementation, but with any luck we&#8217;ll be able to revisit them in future work</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/03/29/data-models-and-cassandra/">Data Models and Cassandra</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-29T12:00:00-05:00" pubdate data-updated="true">Mar 29<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/03/data-models-and-cassandra.html">Heuristic Fencepost</a></p>

<p><a href="http://cassandra.apache.org">Cassandra</a> implements a <a href="http://wiki.apache.org/cassandra/DataModel">data model built on ColumnFamilies</a> which differs from both SQL and document-oriented databases such as CouchDB.  We want to spend a little time with this data model, get to know it a bit, so we setup a simple but quasi-realistic problem space: given a database of tweets, tweet authors and tweet followers attempt to answer a sequence of questions about that data.  The questions should increase in complexity and each new question should explore a different facet of the data model.</p>

<p>The examples below are implemented in Python with a little help from a few excellent libraries:</p>

<ul>
<li><a href="https://github.com/pycassa/pycassa">Pycassa</a> for interacting with Cassandra.</li>
<li><a href="http://mike.verdone.ca/twitter/">Twitter tools</a> when we have to interact with Twitter via their REST API</li>
</ul>


<p>We&#8217;ll begin by looking at how we might query an Cassandra instance populated with data in order to find the answers to the questions in our problem space. We&#8217;ll close by briefly discussing how to get the data into Cassandra.</p>

<p>We should be all set; bring on the questions!</p>

<h2>FOR EACH AUTHOR: WHAT LANGUAGE DO THEY WRITE THEIR TWEETS IN AND HOW MANY FOLLOWERS DO THEY HAVE?</h2>

<p>The organizing structure of the Cassandra data model is the column family defined within a keyspace. The keyspace is exactly what it sounds like: a collection of keys, each identifying a distinct entity in your data model. Each column family represents a logical grouping of data about these keys. This data is represented by one or more columns, which are really not much more than a tuple containing a name, value and timestamp. A column family can contain one or more columns for a key in the keyspace, and as it turns out you have a great deal of flexibility here; columns in a column family don&#8217;t have to be defined in advance and do not have to be the same for all keys.</p>

<p>We begin by imagining a column family named &#8220;authors&#8221; in a keyspace defined by the user&#8217;s Twitter handle or screen name. Assume that for each of these keys the &#8220;authors&#8221; column family contains a set of columns, one for each property returned by the &#8220;user/show&#8221; resource found in the Twitter REST API. Let&#8217;s further assume that included in this data are fields named &#8220;lang&#8221; and &#8220;followers_count&#8221; and that these fields correspond to exactly the data we&#8217;re looking for. We can satisfy our requirement by using a range query to identify all keys that fall within a specified range. In our case we want to include all alphanumeric screen names so we query across the range of printable ASCII characters. The Pycassa API makes this very easy [1]:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">authors_cf</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">,[</span><span class="s">&quot;lang&quot;</span><span class="p">,</span><span class="s">&quot;followers_count&quot;</span><span class="p">]):</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Key: </span><span class="si">%s</span><span class="s">, language: </span><span class="si">%s</span><span class="s">, followers: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">[</span><span class="s">&quot;lang&quot;</span><span class="p">],</span><span class="n">values</span><span class="p">[</span><span class="s">&quot;followers_count&quot;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is exactly what we wanted:</p>

<pre><code>[@varese src]$ python Query1.py 
Key: Alanfbrum, language: en, followers: 73
Key: AloisBelaska, language: en, followers: 8
Key: DASHmiami3, language: en, followers: 11
Key: DFW_BigData, language: en, followers: 21
...
</code></pre>

<h2>HOW MANY TWEETS DID EACH AUTHOR WRITE?</h2>

<p>Okay, so we&#8217;ve got the idea of a column family; we can use them to define a set of information for keys in our keyspace. Clearly this is a useful organizing principle, but in some cases we need a hierarchy that goes a bit deeper. The set of tweets written by an author illustrates just such a case: tweets are written by a specific author, but each tweet has data of it&#8217;s own (the actual content of the tweet, a timestamp indicating when it&#8217;s written, perhaps some geo-location info, etc.). How can we represent this additional level of hierarchy?</p>

<p>We could define a new keyspace consisting of some combination of the author&#8217;s screen name and the tweet ID but this doesn&#8217;t seem terribly efficient; identifying all tweets written by an author is now unnecessarily complicated. Fortunately Cassandra provides a super column family which meets our needs exactly. The value of each column in a super column family is itself a collection of regular columns.</p>

<p>Let&#8217;s apply this structure to the problem at hand. Assume that we also have a super column family named &#8220;tweets&#8221; within our keyspace. For each key we define one or more super columns, one for each tweet written by the author identified by the key. The value of any given super column is a collection of columns, one for each field contained in the results we get when we search for tweets using Twitter&#8217;s search API. Once again we utilize a range query to access the relevant keys:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Key in return value from &quot;tweets&quot; super column family is the</span>
</span><span class='line'><span class="c"># tweet ID, value is a map of per-tweet data. We&#39;re only interested</span>
</span><span class='line'><span class="c"># in the number of tweets so we only need to compute the size</span>
</span><span class='line'><span class="c"># of the returned hash.</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tweets_cf</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Authors: </span><span class="si">%s</span><span class="s">, tweets written: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this script gives us the following:</p>

<pre><code>[@varese src]$ python Query2.py
Authors: Alanfbrum, tweets written: 1
Authors: AloisBelaska, tweets written: 1
Authors: DASHmiami3, tweets written: 1
Authors: DFW_BigData, tweets written: 1
...
Authors: LaariPimenteel, tweets written: 2
Authors: MeqqSmile, tweets written: 1
Authors: Mesoziinha, tweets written: 2
</code></pre>

<h2>HOW MANY TWEET AUTHORS ARE ALSO FOLLOWERS OF @SPYCED?</h2>

<p>We&#8217;re now attempting to replicate functionality that looks very much like a join in a relational database.  Somehow we have to relate one type of resource (the set of followers for a Twitter user) to the set of authors defined in our &#8220;authors&#8221; column family. The Twitter REST API exposes the set of user IDs that follow a given user, so one approach to this problem might be to obtain these IDs and, for each of them, query the &#8220;authors&#8221; table to see if we have an author with a matching ID. As for the user to search for&#8230; well, <a href="http://spyced.blogspot.com">Jonathan Ellis</a> (@spyced) seemed like the obvious choice.</p>

<p>Newer versions of Cassandra provide support for indexed slices on a column family. The database maintains an index for a named column within a column family, enabling very efficient lookups for rows in which the column matches a simple query. Query terms can test for equality or whether a column value is greater than or less than an input value [2]. Multiple search clauses can be combined within a single query, but in our case we&#8217;re interested in strict equality only. Our solution to this problem looks something like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">twitter.api</span> <span class="kn">import</span> <span class="n">Twitter</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pycassa.index</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Iterate through the set of IDs returned by the Twitter API and execute</span>
</span><span class='line'><span class="c"># an index search against each ID. The Pycassa API will return a generator</span>
</span><span class='line'><span class="c"># for each query so we make use of the for expression to determine when</span>
</span><span class='line'><span class="c"># we should increment the total count.</span>
</span><span class='line'><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">for</span> <span class="n">authorid</span> <span class="ow">in</span> <span class="n">twitter</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">ids</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&quot;spyced&quot;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">author_expr</span> <span class="o">=</span> <span class="n">create_index_expression</span><span class="p">(</span><span class="s">&#39;id_str&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">authorid</span><span class="p">))</span>
</span><span class='line'>    <span class="n">author_clause</span> <span class="o">=</span> <span class="n">create_index_clause</span><span class="p">([</span><span class="n">author_expr</span><span class="p">])</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">authorkey</span><span class="p">,</span><span class="n">authorprops</span><span class="p">)</span> <span class="ow">in</span> <span class="n">authors_cf</span><span class="o">.</span><span class="n">get_indexed_slices</span><span class="p">(</span><span class="n">author_clause</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">authorkey</span>
</span><span class='line'>        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">print</span> <span class="n">count</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result looks pretty promising:</p>

<pre><code>[@varese src]$ python Query3.py
tlberglund
evidentsoftware
sreeix
...
joealex
cassandra
21
</code></pre>

<p>Some spot checking of these results using the Twitter Web interface seems to confirm the results.</p>

<h2>POPULATING THE DATA</h2>

<p>So far we&#8217;ve talked about accessing data from a Cassandra instance that has already been populated with the data we need. But how do we get it in there in the first place? The answer to this question is a two-step process; first we create the relevant structures within Cassandra and then we use our Python tools to gather and add the actual data.</p>

<p>My preferred tool for managing my Cassandra instance is the pycassaShell that comes with Pycassa. This tool makes it&#8217;s easy to create the column families and indexes we&#8217;ve been working with:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_keyspace</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="n">replication_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_column_family</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;authors&#39;</span><span class="p">,</span><span class="n">comparator_type</span><span class="o">=</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_column_family</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;tweets&#39;</span><span class="p">,</span><span class="nb">super</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">comparator_type</span><span class="o">=</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;authors&#39;</span><span class="p">,</span><span class="s">&#39;id_str&#39;</span><span class="p">,</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are plenty of similar tools around; your mileage may vary.</p>

<p>When it comes to the heavy lifting, we combine Pycassa and Twitter tools into a simple script that does everything we need:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">twitter.api</span> <span class="kn">import</span> <span class="n">Twitter</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">ifilterfalse</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Query to use when finding tweets.</span>
</span><span class='line'><span class="n">searchquery</span> <span class="o">=</span> <span class="s">&quot;#cassandra&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Borrowed from the itertools docs</span>
</span><span class='line'><span class="k">def</span> <span class="nf">unique_everseen</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>    <span class="s">&quot;List unique elements, preserving order. Remember all elements ever seen.&quot;</span>
</span><span class='line'>    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span class='line'>    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ifilterfalse</span><span class="p">(</span><span class="n">seen</span><span class="o">.</span><span class="n">__contains__</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
</span><span class='line'>            <span class="n">seen_add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span class='line'>            <span class="k">yield</span> <span class="n">element</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span class='line'>            <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span class='line'>                <span class="n">seen_add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span class='line'>                <span class="k">yield</span> <span class="n">element</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">populate</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># The Twitter API returns Unicode vals for all string results.  In addition</span>
</span><span class='line'>    <span class="c"># Pycassa appears to complain when we give it a string encoded in something</span>
</span><span class='line'>    <span class="c"># other than UTF-8 or a non-string value.  To get around this we perform</span>
</span><span class='line'>    <span class="c"># an intelligent string conversion; if we get a Unicode type return the</span>
</span><span class='line'>    <span class="c"># UTF-8 encoding of that string, otherwise return the standard string</span>
</span><span class='line'>    <span class="c"># representation.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">smart_str</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s">&quot;search.twitter.com&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">search_results</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">searchquery</span><span class="p">,</span><span class="n">rpp</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tweets</span> <span class="o">=</span> <span class="n">search_results</span><span class="p">[</span><span class="s">&quot;results&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="n">tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">tweets</span><span class="p">:</span>
</span><span class='line'>        <span class="n">tweet_str</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">smart_str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tweet</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
</span><span class='line'>        <span class="n">tweets_cf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tweet</span><span class="p">[</span><span class="s">&quot;from_user&quot;</span><span class="p">],{</span><span class="n">tweet</span><span class="p">[</span><span class="s">&quot;id_str&quot;</span><span class="p">]:</span><span class="n">tweet_str</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> tweets&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tweets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">author_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_everseen</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="s">&quot;from_user&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tweets</span><span class="p">]))</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> distinct authors&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">author_names</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Convert everything into strings; in Cassandra name and values of a column</span>
</span><span class='line'>    <span class="c"># are apparently normally converted into strings</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">author_info</span> <span class="ow">in</span> <span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">author_names</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">author_name</span> <span class="o">=</span> <span class="n">author_info</span><span class="p">[</span><span class="s">&#39;screen_name&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">author_info_str</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">smart_str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">author_info</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
</span><span class='line'>        <span class="n">authors_cf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">author_name</span><span class="p">,</span><span class="n">author_info_str</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Added data for author </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">author_name</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">populate</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>[1] For sake of brevity this discussion omits a few details, including the configuration of a partitioner and tokens in order to use range queries effectively and how keys are ordered. Consult the project documentation and wiki for additional details.</p>

<p>[2] Here &#8220;greater than&#8221; and &#8220;less than&#8221; are defined in terms of the type provided at index creation time.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/02/04/forks-and-joins-in-scala/">Forks and Joins in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-04T12:00:00-06:00" pubdate data-updated="true">Feb 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/02/forks-and-joins-in-scala.html">Heuristic Fencepost</a></p>

<p>A short while ago Alex Miller (aka puredanger) wrote up a <a href="http://tech.puredanger.com/2011/01/04/forkjoin-clojure">blog entry</a> detailing how to use Clojure to interact with the new fork/join concurrency framework to be included with Java7 (and already available from Doug Lea&#8217;s site). The meat of Alex&#8217;s solution is a Java wrapper for Clojure&#8217;s IFn type which integrates nicely with the fork/join framework. At the time there was some discussion about whether a Scala implementation would require an equivalent amount of scaffolding. It turns out that supporting this functionality in Scala requires a bit more effort than one might expect, although the problems one faces are quite different than what Alex worked through in Clojure. We review the steps to a working Scala implementation and see what we can learn from them.</p>

<p>Before we move on, a few notes about fork/join itself. A full overview is outside the scope of this post, however details can be found in the <a href="http://gee.cs.oswego.edu/dl/concurrency-interest/index.html">jsr166y section of Doug Lea&#8217;s site</a>. A solid (although slightly out-of-date) review can be found in a <a href="http://www.ibm.com/developerworks/java/library/j-jtp11137/index.html">developerWorks article</a> by Brian Goetz.</p>

<p>We begin as simply as possible; a straight port of Alex&#8217;s code (in this case an implementation of Fibonacci using fork/join) to Scala. We create a named function fib that will be recursively called by our RecursiveTasks. We also use an implicit conversion to map no-arg anonymous functions onto RecursiveTask instances using the <a href="http://absurdfarce.github.io/blog/2011/01/07/transmutation-of-scala-closures-into-sam-instances/">technique for supporting SAM interfaces</a> discussed in an earlier post. The resulting code looks pretty good:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTestFailOne</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">RecursiveTask</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span> <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">compute</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately an attempt to build with sbt gives an unexpected error:</p>

<pre><code>[info] == test-compile ==
[info]   Source analysis: 2 new/modified, 0 indirectly invalidated, 0 removed.
[info] Compiling test sources...
[error] .../src/test/scala/org/fencepost/forkjoin/ForkJoinTestFailOne.scala:23: method compute cannot be accessed in jsr166y.RecursiveTask[Int]
[error]       (f2 compute) + (f1 join)
[error]           ^
[error] one error found
</code></pre>

<p>A bit of investigation reveals the problem; RecursiveTask.compute() is a protected abstract method in the fork/join framework. The compute method in the class returned by our implicit conversion consists of nothing more than a call to fib.apply() but there&#8217;s no way to know this when fib is defined. It follows that an attempt to access RecursiveTask.compute() from within the body of fib is (correctly) understood as an attempt to access a protected method.</p>

<p>How does Alex get around this problem in Clojure? He doesn&#8217;t; the problem is actually resolved via the Java wrapper. Note that in his Java code compute() has been &#8220;elevated&#8221; to be a public method. He&#8217;s thus able to call this method without issue from his &#8220;fib-task&#8221; function. Without this modification his code fails with similar errors [1].</p>

<p>Strangely, there&#8217;s no obvious way to resolve this issue within Scala itself. The language provides protected and private keywords to restrict access to certain methods but there is no public keyword; methods are assumed to be public if not annotated otherwise. As a consequence there&#8217;s no obvious way to &#8220;raise&#8221; the access level of a method in a subclass. We work around this constraint by way of an egregious hack; we define a new subclass of RecursiveTask containing a surrogate method that provides public access to compute. We then return this subclass from our implicit conversion.</p>

<p>Our new implementation looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTestFailTwo</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">somefunc</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">somefunc</span><span class="o">.</span><span class="n">apply</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// RecursiveTask.compute() is protected and there&#39;s no obvious way to</span>
</span><span class='line'>    <span class="c1">// elevate it&#39;s access level within a Scala class definition.  The type</span>
</span><span class='line'>    <span class="c1">// system (very correctly) doesn&#39;t allow a random function access to</span>
</span><span class='line'>    <span class="c1">// protected methods of a class even when that method is invoked by</span>
</span><span class='line'>    <span class="c1">// a method within the class itself.  Defining a new method with standard</span>
</span><span class='line'>    <span class="c1">// access resolves the issue.</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">surrogate</span> <span class="k">=</span> <span class="n">compute</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">fn</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">compute</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code now compiles, but when we try to actually execute the test with sbt we see a curious error; the test starts up and then simply hangs:</p>

<pre><code>[info] == test-compile ==
[info] 
[info] == copy-test-resources ==
[info] == copy-test-resources ==
[info] 
[info] == test-start ==
[info] == test-start ==
[info] 
[info] == org.fencepost.forkjoin.ForkJoinTestFailTwo ==
[info] Test Starting: testFibonacci
*wait for a long, long time*
</code></pre>

<p>Well, this isn&#8217;t good. What&#8217;s going on here?</p>

<p>The key point to understand is that the implicit conversion is called every time an existing value needs to be converted to a different type. As written the calls to f1.fork() and f1.join() both require conversion, and the implicit conversion function in play here will return a new instance on each invocation. This means that even though the input to the conversion function is identical in both cases (f1) the object that invokes fork() will be a different object than that which invokes join(). For fork/join tasks this matters; join() is called on an object that was never forked(). Voila, an unterminated wait.</p>

<p>We can resolve this issue one of two ways:</p>

<ul>
<li>Caching previous values returned by the implicit conversion function and re-using them when appropriate</li>
<li>Explicitly specifying the type of f1 and f2 as our wrapper subclass. This has the effect of forcing implicit conversion at the time of assignment rather than when we call fork() and join()</li>
</ul>


<p>I chose the first approach, mainly because it seemed a bit cooler. Oh, and it&#8217;s a bit cleaner logically as well. The final result runs without issue:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable.LinkedList</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTest</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">cache</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">[(()</span><span class="k">=&gt;</span><span class="kt">Int</span>,<span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">])]()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">somefunc</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">somefunc</span><span class="o">.</span><span class="n">apply</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// RecursiveTask.compute() is protected and there&#39;s no obvious way to</span>
</span><span class='line'>    <span class="c1">// elevate it&#39;s access level within a Scala class definition.  The type</span>
</span><span class='line'>    <span class="c1">// system (very correctly) doesn&#39;t allow a random function access to</span>
</span><span class='line'>    <span class="c1">// protected methods of a class even when that method is invoked by</span>
</span><span class='line'>    <span class="c1">// a method within the class itself.  Defining a new method with standard</span>
</span><span class='line'>    <span class="c1">// access resolves the issue.</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">surrogate</span> <span class="k">=</span> <span class="n">compute</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Rationale for a caching implicit conversion can be found below.  We use</span>
</span><span class='line'>  <span class="c1">// a list of tuples rather than a map since hashing buys us nothing here;</span>
</span><span class='line'>  <span class="c1">// there is always one (and exactly one) object with a given object identity.</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">cacheval</span> <span class="k">=</span> <span class="n">cache</span> <span class="n">find</span> <span class="o">(</span><span class="n">t</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">_1</span> <span class="n">eq</span> <span class="n">fn</span><span class="o">))</span>
</span><span class='line'>    <span class="n">cacheval</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Some</span><span class="o">((</span><span class="k">_</span><span class="o">,</span><span class="n">cval</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">cval</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">val</span> <span class="n">newcval</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">fn</span><span class="o">)</span>
</span><span class='line'>          <span class="n">cache</span><span class="o">.</span><span class="n">next</span> <span class="k">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">next</span> <span class="o">:+</span> <span class="o">(</span><span class="n">fn</span><span class="o">,</span><span class="n">newcval</span><span class="o">)</span>
</span><span class='line'>          <span class="n">newcval</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// The approach used here only works if our implicit conversion always</span>
</span><span class='line'>      <span class="c1">// returns the same Wrapper instance for a given function.  For a given</span>
</span><span class='line'>      <span class="c1">// RecursiveTask instance join() must be called on the same instance that</span>
</span><span class='line'>      <span class="c1">// originally called fork().  It follows that an implicit conversion such</span>
</span><span class='line'>      <span class="c1">// as:</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// implicit def fn2wrapper(fn:()=&gt;Int):Wrapper[Int] = {</span>
</span><span class='line'>      <span class="c1">//    return new Wrapper(fn)</span>
</span><span class='line'>      <span class="c1">// }</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// won&#39;t be adequate; fork() and join() will be called on two separate</span>
</span><span class='line'>      <span class="c1">// objects (since implicit conversion is performed on each method call)</span>
</span><span class='line'>      <span class="c1">// and join() will never return.</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// Alternately we can force conversion when f1 and f2 are assigned values</span>
</span><span class='line'>      <span class="c1">// using something like the following;</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// val f1:Wrapper[Int] = { ()=&gt; fib(n - 1) }</span>
</span><span class='line'>      <span class="c1">// val f2:Wrapper[Int] = { ()=&gt; fib(n - 2) }</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// Clearly in this case f1.fork() and f1.join() will be called on the</span>
</span><span class='line'>      <span class="c1">// same instance of a RecursiveTask subclass.</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">surrogate</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>[1] Using Alex&#8217;s code (as published on his blog):</p>

<pre><code>bartok ~/git/puredanger_forkjoin $ clojure process.clj 
(1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181)
</code></pre>

<p>After changing IFnTask.compute() to protected (with no other changes):</p>

<pre><code>bartok ~/git/puredanger_forkjoin $ clojure process.clj 
(Exception in thread "main" java.lang.reflect.InvocationTargetException
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:616)
 at jline.ConsoleRunner.main(Unknown Source)
Caused by: java.lang.RuntimeException: java.lang.IllegalArgumentException: No matching field found: compute for class revelytix.federator.process.IFnTask (process.clj:0)
 at clojure.lang.Compiler.eval(Compiler.java:5440)
 at clojure.lang.Compiler.load(Compiler.java:5857)
 at clojure.lang.Compiler.loadFile(Compiler.java:5820)
 at clojure.main$load_script.invoke(main.clj:221)
 at clojure.main$script_opt.invoke(main.clj:273)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/07/transmutation-of-scala-closures-into-sam-instances/">Transmutation of Scala Closures Into SAM Instances</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-07T12:00:00-06:00" pubdate data-updated="true">Jan 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/01/transmutation-of-scala-closures-into.html">Heuristic Fencepost</a></p>

<p>Okay, it&#8217;s not actually <em>alchemy</em>. But it is pretty cool nonetheless.</p>

<p>A brief refresher on terminology: a <em>single abstract method</em> (or SAM) interface or abstract method contains exactly one method that concrete implementations must define. Java includes a number of interfaces that satisfy this property, including Runnable, Callable and Comparable.</p>

<p>The basic idea at play here is that a closure or anonymous function (either will do here) can be used in place of a SAM implementation if the parameters and return type of the closure match up to those of the method. That assumes your language cares about such things, of course; duck typing makes this less of an issue (as we&#8217;ll see).</p>

<p>JRuby automatically performs this operation via <a href="https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby">closure conversion</a> (scroll down to the bottom of the page). Stuart Sierra has recently <a href="http://stuartsierra.com/2010/12/16/single-abstract-method-macro">published</a> a macro for doing something similar in Clojure. Even Java is considering including this feature in an eventual closure implementation (see Brian Goetz&#8217;s <a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-state-2.html">writeup</a> for details). Why should Scala miss out on all the fun?</p>

<p>Let&#8217;s take a look at some code to make this discussion more tangible. A simple example of closure conversion in JRuby looks  something like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">queue</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">LinkedBlockingQueue</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span><span class='line'><span class="nb">exec</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">TimeUnit</span><span class="o">::</span><span class="no">SECONDS</span><span class="p">,</span><span class="n">queue</span><span class="p">)</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">prestartAllCoreThreads</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Use a closure that does some kind of computation rather than just returning a value.                                                                                        </span>
</span><span class='line'><span class="c1"># As always last expression in the closure is the return value.                                                                                                               </span>
</span><span class='line'><span class="n">future</span> <span class="o">=</span> <span class="nb">exec</span><span class="o">.</span><span class="n">submit</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">arr</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="mi">1</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="n">arr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">arr</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">shutdown</span>
</span><span class='line'><span class="n">rv</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'><span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">include?</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">include?</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">print</span> <span class="s2">&quot;Good</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">print</span> <span class="s2">&quot;Not good</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where duck typing helps us out; the only real requirement on our closure is that we actually return something (in order to clearly distinguish between Runnable and Callable). Our objective is to implement a Scala unit test that does something similar. Any such approach will be built around Scala&#8217;s support for implicit conversion of types, but in this case a bit of care and feeding is required to line up the parameters and return types of the closure with that of the contents of the SAM interface. The basic approach works as follows:</p>

<ul>
<li>The implicit conversion accepts a function with the same parameter list and return value as the lone method in the SAM interface</li>
<li>The conversion then returns a new concrete instance of the SAM interface. The implementation of the method doesn&#8217;t need to be anything other than invoking apply() on the input function</li>
</ul>


<p>The resulting Scala implementation (implemented as a ScalaTest class) is:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">java.util.concurrent._</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SAMTest</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2runnable</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Unit</span><span class="o">)</span><span class="k">:</span><span class="kt">Runnable</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span> <span class="k">def</span> <span class="n">run</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2callable</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">A</span><span class="o">)</span><span class="k">:</span><span class="kt">Callable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Callable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="k">def</span> <span class="n">call</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// We can now use a closure as a replacement for a Runnable instance</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">testClosureAsRunnable</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">t</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">({</span> <span class="o">()</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">+=</span> <span class="mi">4</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Addition of new item to the list buffer returns the item added so</span>
</span><span class='line'>        <span class="c1">// leaving it as the last expression would violate our ()=&gt;Unit type.</span>
</span><span class='line'>        <span class="c1">// A simple println solves this.</span>
</span><span class='line'>        <span class="n">println</span><span class="o">(</span><span class="s">&quot;Done&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">})</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">join</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Verify that parameterized types are supported as well while demonstrating</span>
</span><span class='line'>  <span class="c1">// integration with java.util.concurrent.  We deliberately avoid references</span>
</span><span class='line'>  <span class="c1">// to scala.concurrent in order to avoid confusing the issue.</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">testClosureAsParameterizedSAM</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">exec</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">,</span><span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">())</span>
</span><span class='line'>    <span class="n">exec</span><span class="o">.</span><span class="n">prestartAllCoreThreads</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">future</span> <span class="k">=</span> <span class="n">exec</span><span class="o">.</span><span class="n">submit</span><span class="o">({</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span> <span class="o">})</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">future</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">exec</span><span class="o">.</span><span class="n">shutdown</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">6</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/20/a-funny-thing-happened-while-writing-some-haskell/">A Funny Thing Happened While Writing Some Haskell&#8230;.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-20T12:00:00-06:00" pubdate data-updated="true">Dec 20<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2010/12/funny-thing-happened-while-writing-some.html">Heuristic Fencepost</a></p>

<p>Suppose that you&#8217;ve just finished Graham Hutton&#8217;s solid <a href="http://www.cs.nott.ac.uk/~gmh/book.html">introduction</a> to Haskell and now want to take the language for a quick test drive. You decide to stick with something familiar; after noting that the Prelude doesn&#8217;t have an equivalent to Python&#8217;s <a href="http://docs.python.org/2/library/functions.html#range">range</a> function you decide to whip one up yourself. Haskell&#8217;s syntax is still a bit unfamiliar, however, so you decide to implement this function in a different &#8220;mostly functional&#8221; language that you have some experience with. You&#8217;ve been looking for a reason to dip your toes into Scheme again (and it seems to be a good fit here [1]) so you install <a href="http://dynamo.iro.umontreal.ca/wiki/index.php/Main_Page">Gambit Scheme</a> and <a href="http://www.call-cc.org">Chicken Scheme</a> and dig in.</p>

<p>Perhaps you begin with a straightforward recursive definition in Scheme:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">range</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">cons </span><span class="nv">start</span> <span class="p">(</span><span class="nf">range</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">start</span> <span class="nv">step</span><span class="p">)</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">()))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works well enough when start &lt; stop but fails completely when start > stop and step is a negative value (a use case supported by Python&#8217;s range()). To fix this problem we define two procedures via letrec and use whichever is appropriate based on the passed arguments:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">newrange</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">letrec </span>
</span><span class='line'>   <span class="p">((</span><span class="nf">upto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">upto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>      <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>      <span class="o">&#39;</span><span class="p">()))))</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">upto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">downto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This function now works for both start &lt; stop (with positive step) and start > stop (with negative step). There&#8217;s still a problem, though; if we change the sign of step in either of these cases we find ourselves in an infinite loop. Python&#8217;s range() returns an empty list in this case so we probably should too:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">newerrange</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">letrec</span>
</span><span class='line'>  <span class="p">((</span><span class="nf">upto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">upto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>     <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>     <span class="o">&#39;</span><span class="p">()))))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="k">and </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="nv">step</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>          <span class="p">((</span><span class="k">and </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">step</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>          <span class="p">((</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nf">upto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">downto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>While working on these implementations you discover that SRFI-1 includes a function iota which looks similar to Python&#8217;s range(), although this function takes the number of elements in the return list rather than the start/stop/step values we&#8217;re looking for. Still, both Chicken Scheme and Gambit Scheme support SFRI-1 as extensions or modules and we should be able to whip up a thin wrapper around iota to get what we need. Of course we first need to figure out how to load up these modules. And after some initial experimentation we see some curious behaviour in the iota implementation on both platforms&#8230;</p>

<p>But wait&#8230; weren&#8217;t we supposed to be writing some Haskell code?</p>

<p>Oh, yeah.</p>

<p>Haskell&#8217;s guarded equations allow for an easy expression of the same logic we were getting from cons in Scheme. We have no need to translate the recursive logic found in the Scheme version, however, since the list-related functions in the Prelude combined with a few sections gives us everything we need:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">range</span> <span class="n">art</span> <span class="n">op</span> <span class="n">ep</span> <span class="o">|</span> <span class="n">art</span> <span class="o">&lt;</span> <span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kt">[]</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kt">[]</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&lt;</span> <span class="n">op</span> <span class="ow">=</span> <span class="n">takeWhile</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">op</span><span class="p">)</span> <span class="p">(</span><span class="n">iterate</span> <span class="p">(</span><span class="o">+</span><span class="n">ep</span><span class="p">)</span> <span class="n">art</span><span class="p">)</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="n">op</span> <span class="ow">=</span> <span class="n">takeWhile</span> <span class="p">(</span><span class="o">&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">(</span><span class="n">iterate</span> <span class="p">(</span><span class="o">+</span><span class="n">ep</span><span class="p">)</span> <span class="n">art</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In all honesty this is a fairly elegant expression of the algorithm. And while there&#8217;s clearly a lot to like in Haskell this exercise has rekindled a long-dormant romance with Scheme rather than encouraging exploration of something new.</p>

<p>[1] Yes, I realize Scheme isn&#8217;t &#8220;purely functional&#8221;. I&#8217;m not interested in taking a stand in this particular holy war, but there&#8217;s little doubt that Scheme&#8217;s bias against set! and it&#8217;s kin justify the &#8220;mostly functional&#8221; qualifier.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/10/ruby-perl-and-eloquence/">Ruby, Perl and Eloquence</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/05/ruby-and-concurrency-design-with-actors-and-akka/">Ruby and Concurrency: Design with Actors and Akka</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/25/musings-on-list-comprehensions-functional-programming-and-python/">Musings on List Comprehensions, Functional Programming and Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/12/ruby-and-concurrency-the-mechanics-of-akka-and-jruby/">Ruby and Concurrency: The Mechanics of Akka and JRuby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/02/cassandra-and-clojure-things-to-bytes-and-back-again/">Cassandra and Clojure: Things To Bytes And Back Again</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/absurdfarce">@absurdfarce</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'absurdfarce',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bret McGuire -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

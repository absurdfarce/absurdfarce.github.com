
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Absurdity and Farce</title>
  <meta name="author" content="Bret McGuire">

  
  <meta name="description" content="Originally published at Heuristic Fencepost In an attempt to make my Ruby code a bit more idiomatic I&#8217;ve been spending a bit of time recently &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://absurdfarce.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Absurdity and Farce" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Absurdity and Farce</a></h1>
  
    <h2>Searching for the sublime among the ridiculous</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:absurdfarce.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/10/ruby-perl-and-eloquence/">Ruby, Perl and Eloquence</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-10T12:00:00-05:00" pubdate data-updated="true">Jul 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2012/07/ruby-perl-and-eloquence.html">Heuristic Fencepost</a></p>

<p>In an attempt to make my Ruby code a bit more idiomatic I&#8217;ve been spending a bit of time recently with Russ Olsen&#8217;s excellent <a href="http://eloquentruby.com">Eloquent Ruby</a>. There are many reasons to love writing Ruby code, not least of which is that Ruby deploys the same terse but expressive power of Perl while employing better overall principles of programming. The effect isn&#8217;t universal; on occasion my problems with Ruby look quite a bit like my problems with Perl. Given the overall elegance of the language it seems likely that there&#8217;s a &#8220;better&#8221; (or at least more idiomatic) way to accomplish my goal. And so I turn to <em>Eloquent Ruby</em>.</p>

<p>As an example of this tension consider the following example.</p>

<p>Perl has a well-deserved reputation for efficiently processing text files with regular expressions. We&#8217;ll consider an example from another text I&#8217;ve been spending a bit of time with: Hofstadter&#8217;s seminal <a href="http://en.wikipedia.org/wiki/G%C3%B6del,_Escher,_Bach">Godel, Escher, Bach</a>. A simple implementation of the productions of the MIU system in Perl [1] might look like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="nb">open</span> <span class="n">INFILE</span><span class="p">,</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="sr">&lt;INFILE&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">chomp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /#.*/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1IU\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.+?)I$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;M$1$1\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^M(.+)$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1U$2\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)III(.*)$/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$1$2\n&quot;</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)UU(.*)$/</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reasonable enough, but there&#8217;s a lot of magic going on here. We&#8217;re relying on the &#8220;magic&#8221; variable $_ to access the current line, and to make things worse we have to obtain those lines using the INFILE identifier that only has meaning due to a side effect of the open() call [2]. There&#8217;s also those &#8220;magic&#8221; $1 and $2 variables for accessing capture groups in a regex.</p>

<p>The Ruby version is both slightly shorter and a bit cleaner:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span> <span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">next</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/#.*/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">IU</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.+)I$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;M</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}#{</span><span class="vg">$1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^M(.+)$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">U</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.*)III(.*)$/</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}#{</span><span class="vg">$2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(.*)UU(.*)$/</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve made some nice strides here. The use of File.new() allows us to avoid open() and it&#8217;s side effects. The use of a code block allows us to remove the global $_ in favor of a scoped variable line.</p>

<p>But we&#8217;re still stuck with $1 and $2 for those capture groups.</p>

<p>One can imagine an elegant object-oriented solution based on match objects. Any such implementation would have to accomplish three things:</p>

<ul>
<li>The match object will be used as the condition of an if/unless expression so nil should be returned if there&#8217;s no match</li>
<li>The match object should be bound to a variable name in scope</li>
<li>References to capture groups in the if-clause should use the scoped variable rather than the $1,$2, etc.</li>
</ul>


<p>But remember, this exercise is only useful if we don&#8217;t have to compromise on elegance. If all we&#8217;re after is an explicit object-oriented solution we could go with the Python version:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Simple implementation of the productions for the MIU system</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'>
</span><span class='line'><span class="n">re_c</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;#.*&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.+?)I$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^M(.+)$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*)III(.*)$&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">re4</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*)UU(.*)$&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])]:</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">re_c</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span><span class='line'>        <span class="k">continue</span>
</span><span class='line'>    <span class="n">m1</span> <span class="o">=</span> <span class="n">re1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m1</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m1</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;IU&quot;</span>
</span><span class='line'>    <span class="n">m2</span> <span class="o">=</span> <span class="n">re2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;M&quot;</span> <span class="o">+</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">m3</span> <span class="o">=</span> <span class="n">re3</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m3</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m3</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;U&quot;</span> <span class="o">+</span> <span class="n">m3</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">m4</span> <span class="o">=</span> <span class="n">re4</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">m4</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">m4</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">m4</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s probably not what we want. [3]</p>

<p>After pondering this question for a bit we realize we may not be in such a bad spot. /regex/.match(str) already returns nil if there is no match so our first requirement is satisfied. Assignment is just another expression, so our match object (or nil) will be returned to the if-expression test, helping us with our second goal. And match objects provide access to capture groups using []. So long as the assigned variable is in scope we should have everything we need. A bit of scuffling [4] brings us to the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Implementation of the productions for the MIU system with match objects</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span> <span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">next</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/#.*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">foo</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">IU</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.+)I$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;M</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^M(.+)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">U</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.*)III(.*)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}#{</span><span class="n">foo</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">foo</span> <span class="o">=</span> <span class="sr">/^(.*)UU(.*)$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example is free of any &#8220;magic&#8221; variables, although we have sacrificed a bit on the clarity front. It&#8217;s also worth noting that we could have accomplished something very similar in Perl:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># Implementation of the productions for the MIU system with match objects</span>
</span><span class='line'><span class="nb">open</span> <span class="n">INFILE</span><span class="p">,</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="sr">&lt;INFILE&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">chomp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /#.*/</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]IU\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.+?)I$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;M$foo[0]$foo[0]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^M(.+)$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]U$foo[1]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)III(.*)$/</span><span class="p">));</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;$foo[0]$foo[1]\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">@foo</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_</span> <span class="o">=~</span><span class="sr"> /^(.*)UU(.*)$/</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This implementation is hardly idiomatic. It&#8217;s also quite a bit less clear than our earlier efforts in the language.</p>

<p>Where does this leave us? Do we keep in touch with our Perl roots and live with $1 in order to keep things terse and expressive? Do we sacrifice a bit of clarity and go with an object-oriented approach? Or do we do something else entirely?</p>

<p>Answers to this question (and others like it) are what I&#8217;m hoping to get out of <em>Eloquent Ruby</em>.</p>

<p>[1] We&#8217;re ignoring nasty things like error handling and complex edge cases in order to keep the conversation focused.</p>

<p>[2] We could use lexical file handles here but that doesn&#8217;t really change the underlying point. Even in that case we still have to call open() in order for $fh to be useful.</p>

<p>[3] Python does a lot of things very, very well, but this solution to this problem seems unnecessarily verbose.</p>

<p>[4] The requirement to declare foo in advance when using the modifier form of if was a bit surprising. Shifting to an if expression removed this requirement; in that case assignment in the condition. The upcoming Perl version also didn&#8217;t require this advance declaration when using an equivalent to the modifier form. An MRI quirk, perhaps?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/25/musings-on-list-comprehensions-functional-programming-and-python/">Musings on List Comprehensions, Functional Programming and Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-25T12:00:00-06:00" pubdate data-updated="true">Nov 25<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/11/musings-on-list-comprehensions.html">Heuristic Fencepost</a></p>

<p>For simplicity and elegance in your programming constructs the <a href="http://en.wikipedia.org/wiki/List_comprehension">list comprehension</a> is hard to beat. [1] A list comprehension can filter an input list, transform it or do both, all in a single expression and with very readable syntax. At it&#8217;s best a list comprehension is &#8220;beautiful code&#8221; distilled: very clear and expressive with no unnecessary noise. You can, of course, make list comprehensions &#8220;ugly&#8221; but at least you have to try a bit to do so.</p>

<p>List comprehensions have their roots in functional programming and several modern functional languages include support for them. We&#8217;ll see comprehensions in Haskell, Clojure and Scala. [2] Python also includes support for comprehensions; in fact the basis for <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=98196">Guido&#8217;s argument</a> to remove the map and filter functions from py3k was that expressions using these functions could be easily re-written as comprehensions. We also consider comprehensions in Python, including differences between the Python implementation and those in other languages and what effect those differences may have.</p>

<p>Let&#8217;s consider a fairly straightforward problem problem: given a list of (x,y) coordinates in some two-dimensional space provide a list of the coordinates that are within some fixed distance of the origin of (0,0). Our application also requires that results be displayed in <a href="http://en.wikipedia.org/wiki/Polar_coordinates">polar coordinates</a>, so for extra bonus points we should return our results in that notation. We can solve the problem quite easily in Haskell and Clojure using list comprehensions:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">toDegrees</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">toDegrees</span> <span class="n">rad</span> <span class="ow">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>
</span><span class='line'>
</span><span class='line'><span class="nf">euclidean</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">euclidean</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">foo</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>                  <span class="n">bar</span> <span class="ow">=</span> <span class="n">y</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>              <span class="kr">in</span> <span class="n">sqrt</span> <span class="p">(</span><span class="n">foo</span> <span class="o">+</span> <span class="n">bar</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
</span><span class='line'>     <span class="n">print</span> <span class="p">[(</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">,(</span><span class="n">toDegrees</span> <span class="o">.</span> <span class="n">atan</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="ow">&lt;-</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)],(</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">euclidean</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span> <span class="p">(</span><span class="nf">Math/sqrt</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">y</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">for </span><span class="p">[</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">x</span>,<span class="nv">y</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[[</span><span class="mi">1</span>,<span class="mi">2</span><span class="p">]</span>,<span class="p">[</span><span class="mi">2</span>,<span class="mi">3</span><span class="p">]</span>,<span class="p">[</span><span class="mi">3</span>,<span class="mi">4</span><span class="p">]]</span>
</span><span class='line'>      <span class="ss">:when</span> <span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="mf">3.0</span><span class="p">)]</span>
</span><span class='line'>       <span class="p">[(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span>,<span class="p">(</span><span class="nf">Math/toDegrees</span> <span class="p">(</span><span class="nf">Math/atan</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">y</span> <span class="nv">x</span><span class="p">)))]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Scala we use for expressions to accomplish something very similar:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.math.</span><span class="o">{</span><span class="n">atan</span><span class="o">,</span><span class="n">pow</span><span class="o">,</span><span class="n">sqrt</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">),(</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">),(</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">)))</span> <span class="o">&gt;</span> <span class="mf">3.0</span> <span class="o">}</span>
</span><span class='line'>  <span class="k">yield</span> <span class="o">(</span><span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">))),</span><span class="n">toDegrees</span><span class="o">(</span><span class="n">atan</span><span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="n">toFloat</span><span class="o">/</span><span class="n">x</span><span class="o">)))</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, a straightforward solution in Python:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">print</span> <span class="p">[(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that in each of these solutions we&#8217;re doing a bit more work than we need to. Our implementation computes the distance from the origin twice, once when filtering values and again when generating the final output of the transformation process. This seems unnecessary; a better option would be to somehow define this value as intermediate state. This state could then be available to both filter and transform expressions. Haskell and Clojure support the introduction of intermediate bindings in their comprehension syntax:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">toDegrees</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">toDegrees</span> <span class="n">rad</span> <span class="ow">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>
</span><span class='line'>
</span><span class='line'><span class="nf">euclidean</span> <span class="ow">::</span> <span class="kt">Floating</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="nf">euclidean</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">foo</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>                  <span class="n">bar</span> <span class="ow">=</span> <span class="n">y</span> <span class="o">^^</span> <span class="mi">2</span>
</span><span class='line'>              <span class="kr">in</span> <span class="n">sqrt</span> <span class="p">(</span><span class="n">foo</span> <span class="o">+</span> <span class="n">bar</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
</span><span class='line'>     <span class="n">print</span> <span class="p">[(</span><span class="n">dist</span><span class="p">,(</span><span class="n">toDegrees</span> <span class="o">.</span> <span class="n">atan</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="ow">&lt;-</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)],</span><span class="kr">let</span> <span class="n">dist</span><span class="ow">=</span><span class="n">euclidean</span> <span class="n">x</span> <span class="n">y</span><span class="p">,</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">euclidean</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span> <span class="p">(</span><span class="nf">Math/sqrt</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">Math/pow</span> <span class="nv">y</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">for </span><span class="p">[</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">x</span>,<span class="nv">y</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[[</span><span class="mi">1</span>,<span class="mi">2</span><span class="p">]</span>,<span class="p">[</span><span class="mi">2</span>,<span class="mi">3</span><span class="p">]</span>,<span class="p">[</span><span class="mi">3</span>,<span class="mi">4</span><span class="p">]]</span>
</span><span class='line'>      <span class="ss">:let</span> <span class="p">[</span><span class="nv">dist</span> <span class="p">(</span><span class="nf">euclidean</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)]</span>
</span><span class='line'>       <span class="ss">:when</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">dist</span> <span class="mf">3.0</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">[</span><span class="nv">dist</span>,<span class="p">(</span><span class="nf">Math/toDegrees</span> <span class="p">(</span><span class="nf">Math/atan</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">y</span> <span class="nv">x</span><span class="p">)))]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Scala also allows for intermediate bindings within a for expression:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.math.</span><span class="o">{</span><span class="n">atan</span><span class="o">,</span><span class="n">pow</span><span class="o">,</span><span class="n">sqrt</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">),(</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">),(</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="n">dist</span> <span class="k">=</span> <span class="n">sqrt</span><span class="o">((</span><span class="n">pow</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">y</span><span class="o">,</span><span class="mi">2</span><span class="o">)))</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span> <span class="o">}</span>
</span><span class='line'>  <span class="k">yield</span> <span class="o">(</span><span class="n">dist</span><span class="o">,</span><span class="n">toDegrees</span><span class="o">(</span><span class="n">atan</span><span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="n">toFloat</span><span class="o">/</span><span class="n">x</span><span class="o">)))</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about Python? It turns out we cannot solve this problem in Python using a single comprehension; the syntax doesn&#8217;t allow for the introduction of intermediate state which can be used in either the predicate or transform expression. On the face of it this seems a bit odd; the language encourages the use of comprehensions for filtering and/or transformation while providing a less robust version of that very construct. To some degree this discrepancy reflects differing language goals. Guido&#8217;s post on the history of list comprehensions seems to indicate that the motivation for adding these features was pragmatic; the syntax is an elegant way to express most filter and transform operations. Functional languages use list comprehensions as &#8220;syntactic sugar&#8221; for monadic effects [3] that don&#8217;t really have an equivalent in standard Python usage. The syntax may look the same, but if you&#8217;re coming from a functional perspective they can feel just a bit off. The same is true for a few other common functional idioms:</p>

<ul>
<li>Lazy evaluation - List comprehensions in Python are not lazily evaluated. Generator expressions, which look very similar to list comprehensions, are lazily evaluated.</li>
<li>Higher-order functions - Anonymous functions are supported in Python but these functions are famously limited to a single expression. Functions can return functions but for non-trivial functions a named function must be declared and returned.</li>
</ul>


<p>A couple things should be noted here. First, let us clearly state that Python is not and does not claim to be a functional programming language. While absolutely true, this fact doesn&#8217;t change the underlying point. Moving from functional concepts back into Python can be a bit jarring; some things look similar but don&#8217;t behave quite like you&#8217;d expect.</p>

<p>It&#8217;s also worth noting that the inability to solve this problem with list comprehensions in Python doesn&#8217;t mean that this problem cannot be solved in idiomatic Python. We wish to return our intermediate state as well as filter results based on it&#8217;s value; this dual use allows us to solve the problem with nested comprehensions. The inner comprehension will generate the final representation (including the intermediate state) and the outer comprehension will filter results based on that representation. In Python this looks something like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">print</span> <span class="p">[(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span> <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works only because the intermediate state is also returned in the final result. If that state were not explicitly returned (i.e. if it&#8217;s values were used as input to a conditional expression which returned, say, a string value describing the distance) this solution would not apply.</p>

<p>We can also solve this problem using generators. Using the state maintained by the generator we can iterate through the list, compute the intermediate state and yield a value only when we&#8217;ve satisfied our predicate. A generator-based solution would look something like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan</span><span class="p">,</span> <span class="n">degrees</span>
</span><span class='line'><span class="n">data</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'><span class="k">def</span> <span class="nf">somefunc</span><span class="p">(</span><span class="n">alist</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">:</span>
</span><span class='line'>    <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">):</span>
</span><span class='line'>            <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">degrees</span><span class="p">(</span><span class="n">atan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">)))</span>
</span><span class='line'><span class="k">print</span> <span class="nb">list</span><span class="p">(</span><span class="n">somefunc</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, none of these comments should be construed as a criticism of Python, the design choices that went into the language or the inclusion of list comprehensions generally. The pragmatic case for inclusion of this feature seems very strong. This post is interested only in the interplay between these features and similar features in other languages.</p>

<p>[1] Some languages (perhaps most notably Scala) use the term &#8220;for comprehension&#8221; or &#8220;for expression&#8221;, and in some of these languages (Scala again) these constructs are more flexible than a list comprehension. That said, it&#8217;s fairly straightforward to make Scala&#8217;s for expressions behave like conventional list comprehensions.</p>

<p>[2] A purist might object that Scala is designed to mix features of object-oriented and functional languages, but the bias in favor of functional constructs justifies Scala&#8217;s inclusion here.</p>

<p>[3] As an example, note that in Haskell list comprehensions can be replaced with do-notation. See the Haskell wiki for details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/24/cassandra-and-clojure-the-beginning-of-a-beautiful-friendship/">Cassandra and Clojure: The Beginning of a Beautiful Friendship</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-24T12:00:00-05:00" pubdate data-updated="true">May 24<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/05/cassandra-and-clojure-beginning-of.html">Heuristic Fencepost</a></p>

<p>Soon after I began working with <a href="http://cassandra.apache.org">Cassandra</a> it became clear to me that if you were in the market for a platform for creating applications that interact with this database you could do a lot worse than <a href="http://clojure.org">Clojure</a>. The lack of a query language [1] suggests that filtering and slicing lists of keys and columns might be a fairly common activity for apps powered by Cassandra. And while many languages support the map/filter/reduce paradigm Clojure&#8217;s use of <a href="http://clojure.org/sequences">sequences</a> throughout the core suggest a natural means to integrate this data into the rest of your application.</p>

<p>Cassandra itself provides an <a href="http://wiki.apache.org/cassandra/API">API</a> that uses the <a href="http://thrift.apache.org">Thrift</a> protocol for manipulating data. We&#8217;ll use this interface to implement a simple proof-of-concept application that might serve as a testbed for manipulating data managed by Cassandra in idiomatic Clojure. Note that the Clojure ecosystem already includes several open-source projects that connect Clojure to Cassandra: these include <a href="https://github.com/robertluo/clj-cassandra">clj-cassandra</a> and <a href="https://github.com/pingles/clj-hector">clj-hector</a>, the latter leveraging the <a href="http://hector-client.github.io/hector/build/html/index.html">Hector Java client</a> to do it&#8217;s work. In order to keep things simple we choose to avoid any of these third-party libraries; it&#8217;s not as if the Thrift interface imposes a heavy burden on us. Let&#8217;s see how far we can get with what&#8217;s already in the packaging.</p>

<p>That sounds great&#8230; so what exactly are we trying to do? Beginning with the database generated during our <a href="http://absurdfarce.github.io/blog/2011/03/29/data-models-and-cassandra/">previous work</a> with Cassandra we should be able to access sets of keys within a keyspace and a set of columns for any specific key. These structures should be available for manipulation in idiomatic Clojure as sequences. Ideally these sequences would be at least somewhat lazy and transparently support multiple datatypes. [2]</p>

<p>Using the Thrift interface requires working with a fair number of Java objects representing return types and/or arguments to the various exposed functions. My Clojure isn&#8217;t yet solid enough to hash out Java interop code without flailing a bit so we kick things off with a Scala implementation. This approach allows us to simplify the interop problem without sacrificing the functional approach, all within a language that is by now fairly familiar.</p>

<p>The Scala code includes a fair number of intermediate objects but is otherwise fairly clean:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.cassandra</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.JavaConversions</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.thrift.protocol.TBinaryProtocol</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.thrift.transport._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.cassandra.service._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.apache.cassandra.thrift._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ThriftCassandraClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">connect</span><span class="o">(</span><span class="n">host</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">port</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span><span class="n">keyspace</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Cassandra.Client</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">transport</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TFramedTransport</span><span class="o">(</span><span class="k">new</span> <span class="nc">TSocket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">protocol</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TBinaryProtocol</span><span class="o">(</span><span class="n">transport</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Cassandra</span><span class="o">.</span><span class="nc">Client</span><span class="o">(</span><span class="n">protocol</span><span class="o">)</span>
</span><span class='line'>    <span class="n">transport</span><span class="o">.</span><span class="n">open</span><span class="o">()</span>
</span><span class='line'>    <span class="n">client</span> <span class="n">set_keyspace</span> <span class="n">keyspace</span>
</span><span class='line'>    <span class="n">client</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Execute a range slice query against the specified Cassandra instance.  Method returns</span>
</span><span class='line'>  <span class="c1">// an object suitable for later interrogation by range_slices_keys() or range_slices_columns()</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">get_range_slices</span><span class="o">(</span><span class="n">client</span><span class="k">:</span><span class="kt">Cassandra.Client</span><span class="o">,</span><span class="n">cf</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">start</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span><span class="n">end</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">sliceRange</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SliceRange</span><span class="o">()</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setStart</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setFinish</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setReversed</span> <span class="kc">false</span>
</span><span class='line'>    <span class="n">sliceRange</span> <span class="n">setCount</span> <span class="mi">100</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">slicePredicate</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SlicePredicate</span><span class="o">()</span>
</span><span class='line'>    <span class="n">slicePredicate</span> <span class="n">setSlice_range</span> <span class="n">sliceRange</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">columnParent</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ColumnParent</span><span class="o">(</span><span class="n">cf</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">keyRange</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">KeyRange</span><span class="o">()</span>
</span><span class='line'>    <span class="n">keyRange</span> <span class="n">setStart_key</span> <span class="o">(</span><span class="n">start</span> <span class="n">getBytes</span><span class="o">)</span>
</span><span class='line'>    <span class="n">keyRange</span> <span class="n">setEnd_key</span> <span class="o">(</span><span class="n">end</span> <span class="n">getBytes</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">javakeys</span> <span class="k">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_range_slices</span><span class="o">(</span><span class="n">columnParent</span><span class="o">,</span><span class="n">slicePredicate</span><span class="o">,</span><span class="n">keyRange</span><span class="o">,</span><span class="nc">ConsistencyLevel</span><span class="o">.</span><span class="nc">ONE</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Return from Thrift Java client is List&lt;KeySlice&gt; so we have to explicitly convert it here</span>
</span><span class='line'>    <span class="nc">JavaConversions</span> <span class="n">asScalaIterable</span> <span class="n">javakeys</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return an Iterable for all keys in an input query state object</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">range_slices_keys</span><span class="o">(</span><span class="n">slices</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">])</span> <span class="k">=</span> <span class="n">slices</span> <span class="n">map</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getKey</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return an Option containing column information for the specified key in the input query</span>
</span><span class='line'>  <span class="c1">// state object.  If the key isn&#39;t found None is returned, otherwise the Option contains a</span>
</span><span class='line'>  <span class="c1">// map of column names to column values.</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">range_slices_columns</span><span class="o">(</span><span class="n">slices</span><span class="k">:</span><span class="kt">Iterable</span><span class="o">[</span><span class="kt">KeySlice</span><span class="o">],</span> <span class="n">key</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">slices</span> <span class="n">find</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getKey</span><span class="o">())</span> <span class="o">==</span> <span class="n">key</span> <span class="o">}</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">keyval</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="n">urcols</span> <span class="k">=</span> <span class="nc">JavaConversions</span> <span class="n">asScalaIterable</span> <span class="o">(</span><span class="n">keyval</span> <span class="n">getColumns</span><span class="o">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">cols</span><span class="k">:</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Column</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="n">urcols</span> <span class="n">map</span> <span class="o">(</span><span class="k">_</span> <span class="n">getColumn</span><span class="o">)).</span><span class="n">toSeq</span>
</span><span class='line'>        <span class="nc">Some</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="n">cols</span> <span class="n">map</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getName</span><span class="o">()))</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">getValue</span><span class="o">()))</span> <span class="o">}</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="n">connect</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">9160</span><span class="o">,</span><span class="s">&quot;twitter&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">slices</span> <span class="k">=</span> <span class="n">get_range_slices</span><span class="o">(</span><span class="n">client</span><span class="o">,</span><span class="s">&quot;authors&quot;</span><span class="o">,</span><span class="s">&quot;!&quot;</span><span class="o">,</span><span class="s">&quot;~&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">fivekeys</span> <span class="k">=</span> <span class="n">range_slices_keys</span><span class="o">(</span><span class="n">slices</span><span class="o">)</span> <span class="n">take</span> <span class="mi">5</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="s">&quot;fivekeys: &quot;</span> <span class="o">+</span> <span class="n">fivekeys</span><span class="o">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">key</span> <span class="k">&lt;-</span> <span class="n">fivekeys</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">range_slices_columns</span><span class="o">(</span><span class="n">slices</span><span class="o">,</span><span class="n">key</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cols</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">println</span><span class="o">(</span>
</span><span class='line'>            <span class="s">&quot;Key &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span>
</span><span class='line'>            <span class="s">&quot;: name =&gt; &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">cols</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">+</span>
</span><span class='line'>            <span class="s">&quot;, following =&gt; &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">cols</span> <span class="n">getOrElse</span> <span class="o">(</span><span class="s">&quot;following&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">))</span>
</span><span class='line'>          <span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Translating this code into Clojure is more straightforward than expected:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.transport</span> <span class="nv">TFramedTransport</span> <span class="nv">TSocket</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.thrift.protocol</span> <span class="nv">TBinaryProtocol</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">(</span><span class="nf">org.apache.cassandra.thrift</span> <span class="nv">Cassandra$Client</span> <span class="nv">SliceRange</span> <span class="nv">SlicePredicate</span> <span class="nv">ColumnParent</span> <span class="nv">KeyRange</span> <span class="nv">ConsistencyLevel</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">connect</span> <span class="p">[</span><span class="nv">host</span> <span class="nv">port</span> <span class="nv">keyspace</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Connect to a Cassandra instance on the specified host and port.  Set things up to use the specified key space.&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">transport</span> <span class="p">(</span><span class="nf">TFramedTransport.</span> <span class="p">(</span><span class="nf">TSocket.</span> <span class="nv">host</span> <span class="nv">port</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">protocol</span> <span class="p">(</span><span class="nf">TBinaryProtocol.</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">client</span> <span class="p">(</span><span class="nf">Cassandra$Client.</span> <span class="nv">protocol</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.open</span> <span class="nv">transport</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.set_keyspace</span> <span class="nv">client</span> <span class="nv">keyspace</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">client</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get_range_slices</span> <span class="p">[</span><span class="nv">client</span> <span class="nv">cf</span> <span class="nv">start</span> <span class="nv">end</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Simple front end into the get_range_slices function exposed via Thrift&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">slice_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SliceRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setFinish</span> <span class="p">(</span><span class="nf">byte-array</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setReversed</span> <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setCount</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="nv">slice_predicate</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">SlicePredicate.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setSlice_range</span> <span class="nv">slice_range</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">column_parent</span> <span class="p">(</span><span class="nf">ColumnParent.</span> <span class="nv">cf</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">key_range</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">KeyRange.</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setStart_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">start</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setEnd_key</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">end</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.get_range_slices</span> <span class="nv">client</span> <span class="nv">column_parent</span> <span class="nv">slice_predicate</span> <span class="nv">key_range</span> <span class="nv">ConsistencyLevel/ONE</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_keys</span> <span class="p">[</span><span class="nv">slices</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Retrieve the set of keys in a get_range_slices result&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">slices</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">range_slices_columns</span> <span class="p">[</span><span class="nv">slices</span> <span class="nv">key</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Retrieve a map of the columns associated with the specified key in a get_range_slices result&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">match</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">= key </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getKey</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">slices</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cond </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">match</span><span class="p">)</span> <span class="nv">nil</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">true? </span><span class="nv">true</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">urcols</span> <span class="p">(</span><span class="nf">.getColumns</span> <span class="nv">match</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">cols</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">.getColumn</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">urcols</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">zipmap </span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getName</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">cols</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">.getValue</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">cols</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">client</span> <span class="p">(</span><span class="nf">connect</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">9160</span> <span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">key_slices</span> <span class="p">(</span><span class="nf">get_range_slices</span> <span class="nv">client</span> <span class="s">&quot;authors&quot;</span> <span class="s">&quot;!&quot;</span> <span class="s">&quot;~&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">five_keys</span> <span class="p">(</span><span class="nb">take </span><span class="mi">5</span> <span class="p">(</span><span class="nf">range_slices_keys</span> <span class="nv">key_slices</span><span class="p">))]</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="nb">print </span><span class="nv">five_keys</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">formatfn</span>
</span><span class='line'>        <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cols</span> <span class="p">(</span><span class="nf">range_slices_columns</span> <span class="nv">key_slices</span> <span class="nv">key</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Key %s: name =&gt; %s, following =&gt; %s\n&quot;</span> <span class="nb">key </span><span class="p">(</span><span class="nf">cols</span> <span class="ss">:name</span><span class="p">)</span> <span class="p">(</span><span class="nf">cols</span> <span class="ss">:following</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">print </span><span class="p">(</span><span class="nb">reduce str </span><span class="p">(</span><span class="nb">map </span><span class="nv">formatfn</span> <span class="nv">five_keys</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>These results seem fairly promising, although we&#8217;re nowhere near done. This code assumes that all column names and values are strings, a perfectly ridiculous assumption. We also don&#8217;t offer any support for nested data types, although in fairness this was a failing of our earlier work as well. Finally we haven&#8217;t built in much support for lazy evaluation; we lazily convert column names to Clojure keywords but that&#8217;s about it. But fear not, gentle reader; we&#8217;ll revisit some or all of these points in future work.</p>

<p>[1] At least until <a href="https://issues.apache.org/jira/browse/CASSANDRA-1703">CQL</a> arrives in Cassandra 0.8</p>

<p>[2] We won&#8217;t be able to meet these last two goals in our initial implementation, but with any luck we&#8217;ll be able to revisit them in future work</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/03/29/data-models-and-cassandra/">Data Models and Cassandra</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-29T12:00:00-05:00" pubdate data-updated="true">Mar 29<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/03/data-models-and-cassandra.html">Heuristic Fencepost</a></p>

<p><a href="http://cassandra.apache.org">Cassandra</a> implements a <a href="http://wiki.apache.org/cassandra/DataModel">data model built on ColumnFamilies</a> which differs from both SQL and document-oriented databases such as CouchDB.  We want to spend a little time with this data model, get to know it a bit, so we setup a simple but quasi-realistic problem space: given a database of tweets, tweet authors and tweet followers attempt to answer a sequence of questions about that data.  The questions should increase in complexity and each new question should explore a different facet of the data model.</p>

<p>The examples below are implemented in Python with a little help from a few excellent libraries:</p>

<ul>
<li><a href="https://github.com/pycassa/pycassa">Pycassa</a> for interacting with Cassandra.</li>
<li><a href="http://mike.verdone.ca/twitter/">Twitter tools</a> when we have to interact with Twitter via their REST API</li>
</ul>


<p>We&#8217;ll begin by looking at how we might query an Cassandra instance populated with data in order to find the answers to the questions in our problem space. We&#8217;ll close by briefly discussing how to get the data into Cassandra.</p>

<p>We should be all set; bring on the questions!</p>

<h2>FOR EACH AUTHOR: WHAT LANGUAGE DO THEY WRITE THEIR TWEETS IN AND HOW MANY FOLLOWERS DO THEY HAVE?</h2>

<p>The organizing structure of the Cassandra data model is the column family defined within a keyspace. The keyspace is exactly what it sounds like: a collection of keys, each identifying a distinct entity in your data model. Each column family represents a logical grouping of data about these keys. This data is represented by one or more columns, which are really not much more than a tuple containing a name, value and timestamp. A column family can contain one or more columns for a key in the keyspace, and as it turns out you have a great deal of flexibility here; columns in a column family don&#8217;t have to be defined in advance and do not have to be the same for all keys.</p>

<p>We begin by imagining a column family named &#8220;authors&#8221; in a keyspace defined by the user&#8217;s Twitter handle or screen name. Assume that for each of these keys the &#8220;authors&#8221; column family contains a set of columns, one for each property returned by the &#8220;user/show&#8221; resource found in the Twitter REST API. Let&#8217;s further assume that included in this data are fields named &#8220;lang&#8221; and &#8220;followers_count&#8221; and that these fields correspond to exactly the data we&#8217;re looking for. We can satisfy our requirement by using a range query to identify all keys that fall within a specified range. In our case we want to include all alphanumeric screen names so we query across the range of printable ASCII characters. The Pycassa API makes this very easy [1]:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">authors_cf</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">,[</span><span class="s">&quot;lang&quot;</span><span class="p">,</span><span class="s">&quot;followers_count&quot;</span><span class="p">]):</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Key: </span><span class="si">%s</span><span class="s">, language: </span><span class="si">%s</span><span class="s">, followers: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">[</span><span class="s">&quot;lang&quot;</span><span class="p">],</span><span class="n">values</span><span class="p">[</span><span class="s">&quot;followers_count&quot;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is exactly what we wanted:</p>

<pre><code>[@varese src]$ python Query1.py 
Key: Alanfbrum, language: en, followers: 73
Key: AloisBelaska, language: en, followers: 8
Key: DASHmiami3, language: en, followers: 11
Key: DFW_BigData, language: en, followers: 21
...
</code></pre>

<h2>HOW MANY TWEETS DID EACH AUTHOR WRITE?</h2>

<p>Okay, so we&#8217;ve got the idea of a column family; we can use them to define a set of information for keys in our keyspace. Clearly this is a useful organizing principle, but in some cases we need a hierarchy that goes a bit deeper. The set of tweets written by an author illustrates just such a case: tweets are written by a specific author, but each tweet has data of it&#8217;s own (the actual content of the tweet, a timestamp indicating when it&#8217;s written, perhaps some geo-location info, etc.). How can we represent this additional level of hierarchy?</p>

<p>We could define a new keyspace consisting of some combination of the author&#8217;s screen name and the tweet ID but this doesn&#8217;t seem terribly efficient; identifying all tweets written by an author is now unnecessarily complicated. Fortunately Cassandra provides a super column family which meets our needs exactly. The value of each column in a super column family is itself a collection of regular columns.</p>

<p>Let&#8217;s apply this structure to the problem at hand. Assume that we also have a super column family named &#8220;tweets&#8221; within our keyspace. For each key we define one or more super columns, one for each tweet written by the author identified by the key. The value of any given super column is a collection of columns, one for each field contained in the results we get when we search for tweets using Twitter&#8217;s search API. Once again we utilize a range query to access the relevant keys:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Key in return value from &quot;tweets&quot; super column family is the</span>
</span><span class='line'><span class="c"># tweet ID, value is a map of per-tweet data. We&#39;re only interested</span>
</span><span class='line'><span class="c"># in the number of tweets so we only need to compute the size</span>
</span><span class='line'><span class="c"># of the returned hash.</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tweets_cf</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Authors: </span><span class="si">%s</span><span class="s">, tweets written: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this script gives us the following:</p>

<pre><code>[@varese src]$ python Query2.py
Authors: Alanfbrum, tweets written: 1
Authors: AloisBelaska, tweets written: 1
Authors: DASHmiami3, tweets written: 1
Authors: DFW_BigData, tweets written: 1
...
Authors: LaariPimenteel, tweets written: 2
Authors: MeqqSmile, tweets written: 1
Authors: Mesoziinha, tweets written: 2
</code></pre>

<h2>HOW MANY TWEET AUTHORS ARE ALSO FOLLOWERS OF @SPYCED?</h2>

<p>We&#8217;re now attempting to replicate functionality that looks very much like a join in a relational database.  Somehow we have to relate one type of resource (the set of followers for a Twitter user) to the set of authors defined in our &#8220;authors&#8221; column family. The Twitter REST API exposes the set of user IDs that follow a given user, so one approach to this problem might be to obtain these IDs and, for each of them, query the &#8220;authors&#8221; table to see if we have an author with a matching ID. As for the user to search for&#8230; well, <a href="http://spyced.blogspot.com">Jonathan Ellis</a> (@spyced) seemed like the obvious choice.</p>

<p>Newer versions of Cassandra provide support for indexed slices on a column family. The database maintains an index for a named column within a column family, enabling very efficient lookups for rows in which the column matches a simple query. Query terms can test for equality or whether a column value is greater than or less than an input value [2]. Multiple search clauses can be combined within a single query, but in our case we&#8217;re interested in strict equality only. Our solution to this problem looks something like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">twitter.api</span> <span class="kn">import</span> <span class="n">Twitter</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pycassa.index</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Iterate through the set of IDs returned by the Twitter API and execute</span>
</span><span class='line'><span class="c"># an index search against each ID. The Pycassa API will return a generator</span>
</span><span class='line'><span class="c"># for each query so we make use of the for expression to determine when</span>
</span><span class='line'><span class="c"># we should increment the total count.</span>
</span><span class='line'><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">for</span> <span class="n">authorid</span> <span class="ow">in</span> <span class="n">twitter</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">ids</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&quot;spyced&quot;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">author_expr</span> <span class="o">=</span> <span class="n">create_index_expression</span><span class="p">(</span><span class="s">&#39;id_str&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">authorid</span><span class="p">))</span>
</span><span class='line'>    <span class="n">author_clause</span> <span class="o">=</span> <span class="n">create_index_clause</span><span class="p">([</span><span class="n">author_expr</span><span class="p">])</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">authorkey</span><span class="p">,</span><span class="n">authorprops</span><span class="p">)</span> <span class="ow">in</span> <span class="n">authors_cf</span><span class="o">.</span><span class="n">get_indexed_slices</span><span class="p">(</span><span class="n">author_clause</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">authorkey</span>
</span><span class='line'>        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">print</span> <span class="n">count</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result looks pretty promising:</p>

<pre><code>[@varese src]$ python Query3.py
tlberglund
evidentsoftware
sreeix
...
joealex
cassandra
21
</code></pre>

<p>Some spot checking of these results using the Twitter Web interface seems to confirm the results.</p>

<h1>POPULATING THE DATA</h1>

<p>So far we&#8217;ve talked about accessing data from a Cassandra instance that has already been populated with the data we need. But how do we get it in there in the first place? The answer to this question is a two-step process; first we create the relevant structures within Cassandra and then we use our Python tools to gather and add the actual data.</p>

<p>My preferred tool for managing my Cassandra instance is the pycassaShell that comes with Pycassa. This tool makes it&#8217;s easy to create the column families and indexes we&#8217;ve been working with:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_keyspace</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="n">replication_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_column_family</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;authors&#39;</span><span class="p">,</span><span class="n">comparator_type</span><span class="o">=</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_column_family</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;tweets&#39;</span><span class="p">,</span><span class="nb">super</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">comparator_type</span><span class="o">=</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span><span class='line'><span class="n">SYSTEM_MANAGER</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s">&#39;twitter&#39;</span><span class="p">,</span><span class="s">&#39;authors&#39;</span><span class="p">,</span><span class="s">&#39;id_str&#39;</span><span class="p">,</span><span class="n">UTF8_TYPE</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are plenty of similar tools around; your mileage may vary.</p>

<p>When it comes to the heavy lifting, we combine Pycassa and Twitter tools into a simple script that does everything we need:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">twitter.api</span> <span class="kn">import</span> <span class="n">Twitter</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pycassa</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">ifilterfalse</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Query to use when finding tweets.</span>
</span><span class='line'><span class="n">searchquery</span> <span class="o">=</span> <span class="s">&quot;#cassandra&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Borrowed from the itertools docs</span>
</span><span class='line'><span class="k">def</span> <span class="nf">unique_everseen</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>    <span class="s">&quot;List unique elements, preserving order. Remember all elements ever seen.&quot;</span>
</span><span class='line'>    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span class='line'>    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ifilterfalse</span><span class="p">(</span><span class="n">seen</span><span class="o">.</span><span class="n">__contains__</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
</span><span class='line'>            <span class="n">seen_add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span class='line'>            <span class="k">yield</span> <span class="n">element</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span class='line'>            <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span class='line'>                <span class="n">seen_add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span class='line'>                <span class="k">yield</span> <span class="n">element</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">populate</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cassandra</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;twitter&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">authors_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tweets_cf</span> <span class="o">=</span> <span class="n">pycassa</span><span class="o">.</span><span class="n">ColumnFamily</span><span class="p">(</span><span class="n">cassandra</span><span class="p">,</span><span class="s">&quot;tweets&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># The Twitter API returns Unicode vals for all string results.  In addition</span>
</span><span class='line'>    <span class="c"># Pycassa appears to complain when we give it a string encoded in something</span>
</span><span class='line'>    <span class="c"># other than UTF-8 or a non-string value.  To get around this we perform</span>
</span><span class='line'>    <span class="c"># an intelligent string conversion; if we get a Unicode type return the</span>
</span><span class='line'>    <span class="c"># UTF-8 encoding of that string, otherwise return the standard string</span>
</span><span class='line'>    <span class="c"># representation.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">smart_str</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s">&quot;search.twitter.com&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">search_results</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">searchquery</span><span class="p">,</span><span class="n">rpp</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tweets</span> <span class="o">=</span> <span class="n">search_results</span><span class="p">[</span><span class="s">&quot;results&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="n">tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">tweets</span><span class="p">:</span>
</span><span class='line'>        <span class="n">tweet_str</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">smart_str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tweet</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
</span><span class='line'>        <span class="n">tweets_cf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tweet</span><span class="p">[</span><span class="s">&quot;from_user&quot;</span><span class="p">],{</span><span class="n">tweet</span><span class="p">[</span><span class="s">&quot;id_str&quot;</span><span class="p">]:</span><span class="n">tweet_str</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> tweets&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tweets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">author_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_everseen</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="s">&quot;from_user&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tweets</span><span class="p">]))</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> distinct authors&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">author_names</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Convert everything into strings; in Cassandra name and values of a column</span>
</span><span class='line'>    <span class="c"># are apparently normally converted into strings</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">author_info</span> <span class="ow">in</span> <span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">author_names</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">author_name</span> <span class="o">=</span> <span class="n">author_info</span><span class="p">[</span><span class="s">&#39;screen_name&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">author_info_str</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">smart_str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">author_info</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
</span><span class='line'>        <span class="n">authors_cf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">author_name</span><span class="p">,</span><span class="n">author_info_str</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Added data for author </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">author_name</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">populate</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>[1] For sake of brevity this discussion omits a few details, including the configuration of a partitioner and tokens in order to use range queries effectively and how keys are ordered. Consult the project documentation and wiki for additional details.</p>

<p>[2] Here &#8220;greater than&#8221; and &#8220;less than&#8221; are defined in terms of the type provided at index creation time.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/02/04/forks-and-joins-in-scala/">Forks and Joins in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-04T12:00:00-06:00" pubdate data-updated="true">Feb 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/02/forks-and-joins-in-scala.html">Heuristic Fencepost</a></p>

<p>A short while ago Alex Miller (aka puredanger) wrote up a <a href="http://tech.puredanger.com/2011/01/04/forkjoin-clojure">blog entry</a> detailing how to use Clojure to interact with the new fork/join concurrency framework to be included with Java7 (and already available from Doug Lea&#8217;s site). The meat of Alex&#8217;s solution is a Java wrapper for Clojure&#8217;s IFn type which integrates nicely with the fork/join framework. At the time there was some discussion about whether a Scala implementation would require an equivalent amount of scaffolding. It turns out that supporting this functionality in Scala requires a bit more effort than one might expect, although the problems one faces are quite different than what Alex worked through in Clojure. We review the steps to a working Scala implementation and see what we can learn from them.</p>

<p>Before we move on, a few notes about fork/join itself. A full overview is outside the scope of this post, however details can be found in the <a href="http://gee.cs.oswego.edu/dl/concurrency-interest/index.html">jsr166y section of Doug Lea&#8217;s site</a>. A solid (although slightly out-of-date) review can be found in a <a href="http://www.ibm.com/developerworks/java/library/j-jtp11137/index.html">developerWorks article</a> by Brian Goetz.</p>

<p>We begin as simply as possible; a straight port of Alex&#8217;s code (in this case an implementation of Fibonacci using fork/join) to Scala. We create a named function fib that will be recursively called by our RecursiveTasks. We also use an implicit conversion to map no-arg anonymous functions onto RecursiveTask instances using the <a href="http://absurdfarce.github.io/blog/2011/01/07/transmutation-of-scala-closures-into-sam-instances/">technique for supporting SAM interfaces</a> discussed in an earlier post. The resulting code looks pretty good:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTestFailOne</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">RecursiveTask</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span> <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">compute</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately an attempt to build with sbt gives an unexpected error:</p>

<pre><code>[info] == test-compile ==
[info]   Source analysis: 2 new/modified, 0 indirectly invalidated, 0 removed.
[info] Compiling test sources...
[error] .../src/test/scala/org/fencepost/forkjoin/ForkJoinTestFailOne.scala:23: method compute cannot be accessed in jsr166y.RecursiveTask[Int]
[error]       (f2 compute) + (f1 join)
[error]           ^
[error] one error found
</code></pre>

<p>A bit of investigation reveals the problem; RecursiveTask.compute() is a protected abstract method in the fork/join framework. The compute method in the class returned by our implicit conversion consists of nothing more than a call to fib.apply() but there&#8217;s no way to know this when fib is defined. It follows that an attempt to access RecursiveTask.compute() from within the body of fib is (correctly) understood as an attempt to access a protected method.</p>

<p>How does Alex get around this problem in Clojure? He doesn&#8217;t; the problem is actually resolved via the Java wrapper. Note that in his Java code compute() has been &#8220;elevated&#8221; to be a public method. He&#8217;s thus able to call this method without issue from his &#8220;fib-task&#8221; function. Without this modification his code fails with similar errors [1].</p>

<p>Strangely, there&#8217;s no obvious way to resolve this issue within Scala itself. The language provides protected and private keywords to restrict access to certain methods but there is no public keyword; methods are assumed to be public if not annotated otherwise. As a consequence there&#8217;s no obvious way to &#8220;raise&#8221; the access level of a method in a subclass. We work around this constraint by way of an egregious hack; we define a new subclass of RecursiveTask containing a surrogate method that provides public access to compute. We then return this subclass from our implicit conversion.</p>

<p>Our new implementation looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTestFailTwo</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">somefunc</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">somefunc</span><span class="o">.</span><span class="n">apply</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// RecursiveTask.compute() is protected and there&#39;s no obvious way to</span>
</span><span class='line'>    <span class="c1">// elevate it&#39;s access level within a Scala class definition.  The type</span>
</span><span class='line'>    <span class="c1">// system (very correctly) doesn&#39;t allow a random function access to</span>
</span><span class='line'>    <span class="c1">// protected methods of a class even when that method is invoked by</span>
</span><span class='line'>    <span class="c1">// a method within the class itself.  Defining a new method with standard</span>
</span><span class='line'>    <span class="c1">// access resolves the issue.</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">surrogate</span> <span class="k">=</span> <span class="n">compute</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">fn</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">compute</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code now compiles, but when we try to actually execute the test with sbt we see a curious error; the test starts up and then simply hangs:</p>

<pre><code>[info] == test-compile ==
[info] 
[info] == copy-test-resources ==
[info] == copy-test-resources ==
[info] 
[info] == test-start ==
[info] == test-start ==
[info] 
[info] == org.fencepost.forkjoin.ForkJoinTestFailTwo ==
[info] Test Starting: testFibonacci
*wait for a long, long time*
</code></pre>

<p>Well, this isn&#8217;t good. What&#8217;s going on here?</p>

<p>The key point to understand is that the implicit conversion is called every time an existing value needs to be converted to a different type. As written the calls to f1.fork() and f1.join() both require conversion, and the implicit conversion function in play here will return a new instance on each invocation. This means that even though the input to the conversion function is identical in both cases (f1) the object that invokes fork() will be a different object than that which invokes join(). For fork/join tasks this matters; join() is called on an object that was never forked(). Voila, an unterminated wait.</p>

<p>We can resolve this issue one of two ways:</p>

<ul>
<li>Caching previous values returned by the implicit conversion function and re-using them when appropriate</li>
<li>Explicitly specifying the type of f1 and f2 as our wrapper subclass. This has the effect of forcing implicit conversion at the time of assignment rather than when we call fork() and join()</li>
</ul>


<p>I chose the first approach, mainly because it seemed a bit cooler. Oh, and it&#8217;s a bit cleaner logically as well. The final result runs without issue:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.forkjoin</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable.LinkedList</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">jsr166y._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ForkJoinTest</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">cache</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">[(()</span><span class="k">=&gt;</span><span class="kt">Int</span>,<span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">])]()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">somefunc</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">RecursiveTask</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span> <span class="k">=</span> <span class="n">somefunc</span><span class="o">.</span><span class="n">apply</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// RecursiveTask.compute() is protected and there&#39;s no obvious way to</span>
</span><span class='line'>    <span class="c1">// elevate it&#39;s access level within a Scala class definition.  The type</span>
</span><span class='line'>    <span class="c1">// system (very correctly) doesn&#39;t allow a random function access to</span>
</span><span class='line'>    <span class="c1">// protected methods of a class even when that method is invoked by</span>
</span><span class='line'>    <span class="c1">// a method within the class itself.  Defining a new method with standard</span>
</span><span class='line'>    <span class="c1">// access resolves the issue.</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">surrogate</span> <span class="k">=</span> <span class="n">compute</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Rationale for a caching implicit conversion can be found below.  We use</span>
</span><span class='line'>  <span class="c1">// a list of tuples rather than a map since hashing buys us nothing here;</span>
</span><span class='line'>  <span class="c1">// there is always one (and exactly one) object with a given object identity.</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2wrapper</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">cacheval</span> <span class="k">=</span> <span class="n">cache</span> <span class="n">find</span> <span class="o">(</span><span class="n">t</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">_1</span> <span class="n">eq</span> <span class="n">fn</span><span class="o">))</span>
</span><span class='line'>    <span class="n">cacheval</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Some</span><span class="o">((</span><span class="k">_</span><span class="o">,</span><span class="n">cval</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">cval</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">val</span> <span class="n">newcval</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Wrapper</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">fn</span><span class="o">)</span>
</span><span class='line'>          <span class="n">cache</span><span class="o">.</span><span class="n">next</span> <span class="k">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">next</span> <span class="o">:+</span> <span class="o">(</span><span class="n">fn</span><span class="o">,</span><span class="n">newcval</span><span class="o">)</span>
</span><span class='line'>          <span class="n">newcval</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testFibonacci</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// The approach used here only works if our implicit conversion always</span>
</span><span class='line'>      <span class="c1">// returns the same Wrapper instance for a given function.  For a given</span>
</span><span class='line'>      <span class="c1">// RecursiveTask instance join() must be called on the same instance that</span>
</span><span class='line'>      <span class="c1">// originally called fork().  It follows that an implicit conversion such</span>
</span><span class='line'>      <span class="c1">// as:</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// implicit def fn2wrapper(fn:()=&gt;Int):Wrapper[Int] = {</span>
</span><span class='line'>      <span class="c1">//    return new Wrapper(fn)</span>
</span><span class='line'>      <span class="c1">// }</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// won&#39;t be adequate; fork() and join() will be called on two separate</span>
</span><span class='line'>      <span class="c1">// objects (since implicit conversion is performed on each method call)</span>
</span><span class='line'>      <span class="c1">// and join() will never return.</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// Alternately we can force conversion when f1 and f2 are assigned values</span>
</span><span class='line'>      <span class="c1">// using something like the following;</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// val f1:Wrapper[Int] = { ()=&gt; fib(n - 1) }</span>
</span><span class='line'>      <span class="c1">// val f2:Wrapper[Int] = { ()=&gt; fib(n - 2) }</span>
</span><span class='line'>      <span class="c1">//</span>
</span><span class='line'>      <span class="c1">// Clearly in this case f1.fork() and f1.join() will be called on the</span>
</span><span class='line'>      <span class="c1">// same instance of a RecursiveTask subclass.</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="n">f1</span> <span class="n">fork</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">(</span><span class="n">f2</span> <span class="n">surrogate</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f1</span> <span class="n">join</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">()</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">((</span><span class="n">pool</span> <span class="n">invoke</span> <span class="o">{</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="n">fib</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">13</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>[1] Using Alex&#8217;s code (as published on his blog):</p>

<pre><code>bartok ~/git/puredanger_forkjoin $ clojure process.clj 
(1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181)
</code></pre>

<p>After changing IFnTask.compute() to protected (with no other changes):</p>

<pre><code>bartok ~/git/puredanger_forkjoin $ clojure process.clj 
(Exception in thread "main" java.lang.reflect.InvocationTargetException
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:616)
 at jline.ConsoleRunner.main(Unknown Source)
Caused by: java.lang.RuntimeException: java.lang.IllegalArgumentException: No matching field found: compute for class revelytix.federator.process.IFnTask (process.clj:0)
 at clojure.lang.Compiler.eval(Compiler.java:5440)
 at clojure.lang.Compiler.load(Compiler.java:5857)
 at clojure.lang.Compiler.loadFile(Compiler.java:5820)
 at clojure.main$load_script.invoke(main.clj:221)
 at clojure.main$script_opt.invoke(main.clj:273)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/07/transmutation-of-scala-closures-into-sam-instances/">Transmutation of Scala Closures Into SAM Instances</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-07T12:00:00-06:00" pubdate data-updated="true">Jan 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2011/01/transmutation-of-scala-closures-into.html">Heuristic Fencepost</a></p>

<p>Okay, it&#8217;s not actually <em>alchemy</em>. But it is pretty cool nonetheless.</p>

<p>A brief refresher on terminology: a <em>single abstract method</em> (or SAM) interface or abstract method contains exactly one method that concrete implementations must define. Java includes a number of interfaces that satisfy this property, including Runnable, Callable and Comparable.</p>

<p>The basic idea at play here is that a closure or anonymous function (either will do here) can be used in place of a SAM implementation if the parameters and return type of the closure match up to those of the method. That assumes your language cares about such things, of course; duck typing makes this less of an issue (as we&#8217;ll see).</p>

<p>JRuby automatically performs this operation via <a href="https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby">closure conversion</a> (scroll down to the bottom of the page). Stuart Sierra has recently <a href="http://stuartsierra.com/2010/12/16/single-abstract-method-macro">published</a> a macro for doing something similar in Clojure. Even Java is considering including this feature in an eventual closure implementation (see Brian Goetz&#8217;s <a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-state-2.html">writeup</a> for details). Why should Scala miss out on all the fun?</p>

<p>Let&#8217;s take a look at some code to make this discussion more tangible. A simple example of closure conversion in JRuby looks  something like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">queue</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">LinkedBlockingQueue</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span><span class='line'><span class="nb">exec</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">TimeUnit</span><span class="o">::</span><span class="no">SECONDS</span><span class="p">,</span><span class="n">queue</span><span class="p">)</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">prestartAllCoreThreads</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Use a closure that does some kind of computation rather than just returning a value.                                                                                        </span>
</span><span class='line'><span class="c1"># As always last expression in the closure is the return value.                                                                                                               </span>
</span><span class='line'><span class="n">future</span> <span class="o">=</span> <span class="nb">exec</span><span class="o">.</span><span class="n">submit</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">arr</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="mi">1</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="n">arr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">arr</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">shutdown</span>
</span><span class='line'><span class="n">rv</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'><span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">include?</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">include?</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">print</span> <span class="s2">&quot;Good</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">print</span> <span class="s2">&quot;Not good</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where duck typing helps us out; the only real requirement on our closure is that we actually return something (in order to clearly distinguish between Runnable and Callable). Our objective is to implement a Scala unit test that does something similar. Any such approach will be built around Scala&#8217;s support for implicit conversion of types, but in this case a bit of care and feeding is required to line up the parameters and return types of the closure with that of the contents of the SAM interface. The basic approach works as follows:</p>

<ul>
<li>The implicit conversion accepts a function with the same parameter list and return value as the lone method in the SAM interface</li>
<li>The conversion then returns a new concrete instance of the SAM interface. The implementation of the method doesn&#8217;t need to be anything other than invoking apply() on the input function</li>
</ul>


<p>The resulting Scala implementation (implemented as a ScalaTest class) is:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">java.util.concurrent._</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SAMTest</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2runnable</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="nc">Unit</span><span class="o">)</span><span class="k">:</span><span class="kt">Runnable</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span> <span class="k">def</span> <span class="n">run</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">fn2callable</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fn</span><span class="k">:</span><span class="o">()=&gt;</span><span class="n">A</span><span class="o">)</span><span class="k">:</span><span class="kt">Callable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Callable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="k">def</span> <span class="n">call</span> <span class="k">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">apply</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// We can now use a closure as a replacement for a Runnable instance</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">testClosureAsRunnable</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">t</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">({</span> <span class="o">()</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">+=</span> <span class="mi">4</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Addition of new item to the list buffer returns the item added so</span>
</span><span class='line'>        <span class="c1">// leaving it as the last expression would violate our ()=&gt;Unit type.</span>
</span><span class='line'>        <span class="c1">// A simple println solves this.</span>
</span><span class='line'>        <span class="n">println</span><span class="o">(</span><span class="s">&quot;Done&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">})</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">join</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Verify that parameterized types are supported as well while demonstrating</span>
</span><span class='line'>  <span class="c1">// integration with java.util.concurrent.  We deliberately avoid references</span>
</span><span class='line'>  <span class="c1">// to scala.concurrent in order to avoid confusing the issue.</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">testClosureAsParameterizedSAM</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">exec</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">,</span><span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">())</span>
</span><span class='line'>    <span class="n">exec</span><span class="o">.</span><span class="n">prestartAllCoreThreads</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">future</span> <span class="k">=</span> <span class="n">exec</span><span class="o">.</span><span class="n">submit</span><span class="o">({</span> <span class="o">()</span><span class="k">=&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span> <span class="o">})</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">future</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">exec</span><span class="o">.</span><span class="n">shutdown</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="mi">6</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/20/a-funny-thing-happened-while-writing-some-haskell/">A Funny Thing Happened While Writing Some Haskell&#8230;.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-20T12:00:00-06:00" pubdate data-updated="true">Dec 20<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2010/12/funny-thing-happened-while-writing-some.html">Heuristic Fencepost</a></p>

<p>Suppose that you&#8217;ve just finished Graham Hutton&#8217;s solid <a href="http://www.cs.nott.ac.uk/~gmh/book.html">introduction</a> to Haskell and now want to take the language for a quick test drive. You decide to stick with something familiar; after noting that the Prelude doesn&#8217;t have an equivalent to Python&#8217;s <a href="http://docs.python.org/2/library/functions.html#range">range</a> function you decide to whip one up yourself. Haskell&#8217;s syntax is still a bit unfamiliar, however, so you decide to implement this function in a different &#8220;mostly functional&#8221; language that you have some experience with. You&#8217;ve been looking for a reason to dip your toes into Scheme again (and it seems to be a good fit here [1]) so you install <a href="http://dynamo.iro.umontreal.ca/wiki/index.php/Main_Page">Gambit Scheme</a> and <a href="http://www.call-cc.org">Chicken Scheme</a> and dig in.</p>

<p>Perhaps you begin with a straightforward recursive definition in Scheme:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">range</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">cons </span><span class="nv">start</span> <span class="p">(</span><span class="nf">range</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">start</span> <span class="nv">step</span><span class="p">)</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">()))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works well enough when start &lt; stop but fails completely when start > stop and step is a negative value (a use case supported by Python&#8217;s range()). To fix this problem we define two procedures via letrec and use whichever is appropriate based on the passed arguments:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">newrange</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">letrec </span>
</span><span class='line'>   <span class="p">((</span><span class="nf">upto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">upto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>      <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>      <span class="o">&#39;</span><span class="p">()))))</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">upto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">downto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This function now works for both start &lt; stop (with positive step) and start > stop (with negative step). There&#8217;s still a problem, though; if we change the sign of step in either of these cases we find ourselves in an infinite loop. Python&#8217;s range() returns an empty list in this case so we probably should too:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">newerrange</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">letrec</span>
</span><span class='line'>  <span class="p">((</span><span class="nf">upto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">upto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>     <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">art</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">art</span> <span class="nv">op</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">cons </span><span class="nv">art</span> <span class="p">(</span><span class="nf">downto</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">art</span> <span class="nv">ep</span><span class="p">)</span> <span class="nv">op</span> <span class="nv">ep</span><span class="p">))</span>
</span><span class='line'>     <span class="o">&#39;</span><span class="p">()))))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="k">and </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="nv">step</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>          <span class="p">((</span><span class="k">and </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">step</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>          <span class="p">((</span><span class="nb">&lt; </span><span class="nv">start</span> <span class="nv">stop</span><span class="p">)</span> <span class="p">(</span><span class="nf">upto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">downto</span> <span class="nv">start</span> <span class="nv">stop</span> <span class="nv">step</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>While working on these implementations you discover that SRFI-1 includes a function iota which looks similar to Python&#8217;s range(), although this function takes the number of elements in the return list rather than the start/stop/step values we&#8217;re looking for. Still, both Chicken Scheme and Gambit Scheme support SFRI-1 as extensions or modules and we should be able to whip up a thin wrapper around iota to get what we need. Of course we first need to figure out how to load up these modules. And after some initial experimentation we see some curious behaviour in the iota implementation on both platforms&#8230;</p>

<p>But wait&#8230; weren&#8217;t we supposed to be writing some Haskell code?</p>

<p>Oh, yeah.</p>

<p>Haskell&#8217;s guarded equations allow for an easy expression of the same logic we were getting from cons in Scheme. We have no need to translate the recursive logic found in the Scheme version, however, since the list-related functions in the Prelude combined with a few sections gives us everything we need:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">range</span> <span class="n">art</span> <span class="n">op</span> <span class="n">ep</span> <span class="o">|</span> <span class="n">art</span> <span class="o">&lt;</span> <span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kt">[]</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kt">[]</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&lt;</span> <span class="n">op</span> <span class="ow">=</span> <span class="n">takeWhile</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">op</span><span class="p">)</span> <span class="p">(</span><span class="n">iterate</span> <span class="p">(</span><span class="o">+</span><span class="n">ep</span><span class="p">)</span> <span class="n">art</span><span class="p">)</span>
</span><span class='line'>                <span class="o">|</span> <span class="n">art</span> <span class="o">&gt;</span> <span class="n">op</span> <span class="ow">=</span> <span class="n">takeWhile</span> <span class="p">(</span><span class="o">&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">(</span><span class="n">iterate</span> <span class="p">(</span><span class="o">+</span><span class="n">ep</span><span class="p">)</span> <span class="n">art</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In all honesty this is a fairly elegant expression of the algorithm. And while there&#8217;s clearly a lot to like in Haskell this exercise has rekindled a long-dormant romance with Scheme rather than encouraging exploration of something new.</p>

<p>[1] Yes, I realize Scheme isn&#8217;t &#8220;purely functional&#8221;. I&#8217;m not interested in taking a stand in this particular holy war, but there&#8217;s little doubt that Scheme&#8217;s bias against set! and it&#8217;s kin justify the &#8220;mostly functional&#8221; qualifier.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/10/10/default-arguments-and-implicit-conversions-in-scala/">Default Arguments and Implicit Conversions in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-10T12:00:00-05:00" pubdate data-updated="true">Oct 10<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2010/10/default-arguments-and-implicit.html">Heuristic Fencepost</a></p>

<p>In a <a href="blog/2010/08/23/learning-scala-from-dead-swiss-mathematicians-return-of-palindromes/">previous post</a> we went in search of an implicit conversion from Int to List[Int] such that each member of the list corresponds to the value at an equivalent position in the input Int (i.e. 987 = List(9,8,7)). At the time we mentioned that a properly tail recursive implementation proved to be a bit more complicated than one might expect. In this post we&#8217;ll examine these problems in some detail.</p>

<p>A properly tail recursive implementation of this conversion function makes use of an accumulator array to store state as we recurse.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.defaults</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ImplicitDefaultTest1</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span> <span class="n">acc</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">newmember</span> <span class="k">=</span> <span class="n">arg</span> <span class="o">%</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span> <span class="o">/</span> <span class="mi">10</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">toList</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span><span class="nc">List</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testImplicit</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">0.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">0</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">5.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">5</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">12345.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">98765432.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">98765432</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The test above passes so everything looks good so far. On a second look, however, we note that the wrapper function toList() is less than ideal. The accumulator needs to be initialized to the empty list in order for the function to work correctly but defining a second function just to pass in an extra arg looks like unnecessary cruft. Scala 2.8 introduced default arguments to address situations such as this; perhaps we can deploy default arguments here to clean up our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.defaults</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ImplicitDefaultTest2</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span> <span class="n">acc</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">())</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">newmember</span> <span class="k">=</span> <span class="n">arg</span> <span class="o">%</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span> <span class="o">/</span> <span class="mi">10</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testImplicit</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">0.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">0</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">5.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">5</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">12345.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">98765432.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">98765432</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we attempt to execute the test above we&#8217;re greeted rather rudely by sbt:</p>

<pre><code>[info] Compiling test sources...
[error] .../src/test/scala/org/fencepost/defaults/ImplicitDefaultTest2.scala:21:
 value length is not a member of Int
[error]     assert(0.length == 1)
[error]              ^
[error] .../src/test/scala/org/fencepost/defaults/ImplicitDefaultTest2.scala:22:
 0 of type Int(0) does not take parameters
[error]     assert(0(0) == 0)
...
</code></pre>

<p>Clearly the implicit conversion of Int to List[Int] wasn&#8217;t in play when this test was executed. But why not? Logically int2list(arg:Int, acc:List[Int] = List()) will convert Ints to List[Int] everywhere int2list(arg:Int, acc:List[Int]) does. We can demonstrate the validity of this claim by fooling the compiler using a variation on the front-end function we used before:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">org.fencepost.defaults</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.Suite</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ImplicitDefaultTest3</span> <span class="k">extends</span> <span class="nc">Suite</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span> <span class="n">acc</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">())</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">newmember</span> <span class="k">=</span> <span class="n">arg</span> <span class="o">%</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span> <span class="o">/</span> <span class="mi">10</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="n">newmember</span><span class="o">)</span> <span class="o">:::</span> <span class="n">acc</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">toList</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">testImplicit</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">0.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">0</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">5.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">5</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">12345.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">12345</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mf">98765432.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">(</span><span class="mi">98765432</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As expected this test passes without issue.</p>

<p>My suspicion is that this issue is a side effect of the fact that default arguments apparently aren&#8217;t represented in the type system. It&#8217;s not surprising that int2list(arg:Int, acc:List[Int]) isn&#8217;t available as an implicit conversion; there&#8217;s no way for the runtime to supply the required &#8220;acc&#8221; argument for an input Int instance. This is not true for int2list(arg:Int, acc:List[Int] = List()); in that case the default value of &#8220;acc&#8221; could be used to perform the translation. Note, however, that these two functions are represented by the same type in the Scala runtime:</p>

<pre><code>$ scala
Welcome to Scala version 2.8.0.final (OpenJDK Client VM, Java 1.6.0_18).
Type in expressions to have them evaluated.
Type :help for more information.

scala&gt;   def int2list(arg:Int, acc:List[Int]):List[Int] = {
...
int2list: (arg: Int,acc: List[Int])List[Int]

scala&gt;   def int2list2(arg:Int, acc:List[Int] = List()):List[Int] = {
...
int2list2: (arg: Int,acc: List[Int])List[Int]
</code></pre>

<p>If the type system is unaware that default arguments are available for all arguments other than the type to convert from then it&#8217;s not at all surprising that a function would be excluded from the set of valid implicit conversion functions.</p>

<p>Results tested and verified on both Scala 2.8.0 and 2.8.1 RC2.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/08/23/learning-scala-from-dead-swiss-mathematicians-return-of-palindromes/">Learning Scala From Dead Swiss Mathematicians : Return of Palindromes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-23T12:00:00-05:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2010/08/learning-scala-from-dead-swiss.html">Heuristic Fencepost</a></p>

<p>In a <a href="blog/2010/07/26/learning-scala-from-dead-swiss-mathematicians-palindromes/">recent post</a> we implemented a predicate to identify integers which were also palindromes. Our original implementation converted the input integer to a String in order to more easily access the leading digit, something that can&#8217;t easily be done with an input integer. But is this really the case?</p>

<p>If we could easily convert Integers into a List[Integer] [1] we could then easily access the &#8220;head&#8221; and &#8220;tail&#8221; of this list for purposes of comparison. Ideally this conversion could be automated so that we don&#8217;t have to explicitly track these conversions. Fortunately Scala&#8217;s implicit conversions provide exactly these features. A simple implementation looks something like the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">def</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="o">)</span>
</span><span class='line'>    <span class="nc">List</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span> <span class="o">/</span> <span class="mi">10</span><span class="o">)</span> <span class="o">:::</span> <span class="nc">List</span><span class="o">(</span><span class="n">arg</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s worth taking a moment to point out a few things about this function:</p>

<ul>
<li>We&#8217;re assuming base 10 integers here. We could make the function more flexible by adding a parameter to specify the integers base if necessary</li>
<li>A better implementation would be purely tail recursive, but this turns out to be a bit trickier than expected; more on that in a future post.</li>
</ul>


<p>With this conversion in place we can now define a properly tail recursive predicate to check for palindromes:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">byInt</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">arg</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">arg</span><span class="o">.</span><span class="n">last</span><span class="o">)</span>
</span><span class='line'>    <span class="kc">false</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">byInt</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="n">arg</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Very nice, but Scala&#8217;s pattern matching allows for an even better (by which we mean &#8220;simpler&#8221;) implementation that makes use of pattern guards:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">byIntMatch</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Note that we don&#39;t need to check for lists of length </span>
</span><span class='line'>  <span class="c1">// 0 or length 1 as we do in byInt above.  The first </span>
</span><span class='line'>  <span class="c1">// two cases of our match operation below handle these </span>
</span><span class='line'>  <span class="c1">// cases.</span>
</span><span class='line'>  <span class="n">arg</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">List</span><span class="o">()</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">List</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">arghead</span> <span class="o">::</span> <span class="n">rest</span> <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">arghead</span> <span class="k">=&gt;</span> <span class="n">byIntMatch</span><span class="o">(</span><span class="n">rest</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">rest</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
</span><span class='line'>    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The full implementation can be found at <a href="https://github.com/heuristicfencepost/euler">github</a>. Most of the code discussed here can be found in the org.fencepost.palindrome package; a full solution to Problem 4 using this code is also included.</p>

<p>[1] We use integers here only as a matter of convenience; of course we really only need a Byte as long as we&#8217;re talking about base 256 or less. We can always optimize for space later if needed.</p>

<p>UPDATE - Shortly after completing this post I began another chapter in the &#8220;stairway&#8221; book. That chapter (covering details of the implementation of the List class in Scala) promptly pointed out that the list concatenation operator executes in time proportional to the size of the operand on the left. In order to avoid the performance hit we shift to an approach based on iteration and mutation.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">def</span> <span class="n">int2list</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">buff</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</span><span class='line'>  <span class="k">var</span> <span class="n">counter</span> <span class="k">=</span> <span class="n">arg</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">(</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buff</span> <span class="o">+=</span> <span class="o">(</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>    <span class="n">counter</span> <span class="k">=</span> <span class="o">(</span><span class="n">counter</span> <span class="o">/</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">buff</span> <span class="o">+=</span> <span class="n">counter</span>
</span><span class='line'>  <span class="n">buff</span> <span class="n">toList</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The process for choosing when to use an iterative approach over a functional approach is still somewhat opaque. Scala has an explicit bias in favor of functional methods yet in many cases (including this one) an iterative implementation is the correct one to use. Presumably identifying when to use which approach is largely a function of experience with the language.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/26/learning-scala-from-dead-swiss-mathematicians-palindromes/">Learning Scala From Dead Swiss Mathematicians : Palindromes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-26T12:00:00-05:00" pubdate data-updated="true">Jul 26<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Originally published at <a href="http://heuristic-fencepost.blogspot.com/2010/07/learning-scala-from-dead-swiss.html">Heuristic Fencepost</a></p>

<p>As part of my effort to get up to speed with Scala I returned to an old favorite for exploring new languages; working through some of the problems at <a href="http://projecteuler.net">Project Euler</a>. Posting complete answers to specific problems isn&#8217;t terribly interesting and I have no plans to do so here. That said, some facets of these problems do lead to useful digressions which allow for a deeper exploration of the language. We&#8217;ll dig into one such example here.</p>

<p>The problem under consideration is Problem 4 which asks for &#8220;the largest palindrome made from the product of two 3-digit numbers&#8221;. It doesn&#8217;t take much imagination to determine that part of the solution will involve a method, most likely a function of some kind, for identifying whether a number is in fact a palindrome. Okay, but what would such a method look like? The problem lends itself to a simple recursive implementation: divide the integer into a leading digit, a middle integer and a trailing digit and return false if the leading and trailing digits differ, otherwise return the result of the a recursive call with the middle integer.</p>

<p>Easy enough, but a moments reflection tells us we have a problem; we can access the trailing digit in an integer using the mod function and the base of the input integer but there&#8217;s no easy way to access the leading digit. It&#8217;s not as if Int (or even RichInt) extend Seq[Int] or even Seq[Byte]. Fortunately we can shift the problem domain by observing that an input integer is equivalent to an input String in which each digit of the integer maps to a Char in the String. Even better, Scala offers built-in support for regular expressions, and a fairly simple regex should give us access to both the leading and trailing characters and everything in the middle. So, how does Scala&#8217;s regex support stack up?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Pattern to be used by the regex-based predicate.  </span>
</span><span class='line'><span class="c1">// Absolutely must use conservative matching and </span>
</span><span class='line'><span class="c1">// the backref here to make this work.</span>
</span><span class='line'><span class="k">val</span> <span class="n">palindromePattern</span> <span class="k">=</span> <span class="s">&quot;&quot;&quot;(\d)(\d*?)\1&quot;&quot;&quot;</span><span class="o">.</span><span class="n">r</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Recursive helper function to check for a </span>
</span><span class='line'><span class="c1">//palindrome using a regex</span>
</span><span class='line'><span class="k">def</span> <span class="n">byRegexHelper</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Base case; empty string and single characters </span>
</span><span class='line'>  <span class="c1">// are by definition palindromes.  Place this </span>
</span><span class='line'>  <span class="c1">// test up front so that we can handle input values</span>
</span><span class='line'>  <span class="c1">// of a single character.</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'>  <span class="n">palindromePattern</span><span class="o">.</span><span class="n">unapplySeq</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">matches</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">byRegexHelper</span><span class="o">(</span><span class="n">matches</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Regex-based predicate; convert to a string and call</span>
</span><span class='line'><span class="c1">// the recrusive function</span>
</span><span class='line'><span class="k">def</span> <span class="n">byRegex</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="n">byRegexHelper</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad, actually. It&#8217;s not Perl or Ruby but the deep support for pattern matching in the language combined with relatively easy generation of a Regex from a String makes for a fairly clean syntax. Regex literals would be a small improvement but this is still cleaner than what one finds in Java or even Python.</p>

<p>So we&#8217;ve solved the problem, but can we do better? Do we really need the regex? Strings (or the StringOps they&#8217;re implicitly converted to in 2.8) make use of the SeqLike[Char] trait allowing easy access to the leading and trailing characters using simple method calls. This leads to the following implementation which avoids the overhead of evaluating the regular expression:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Recursive helper function to perform the check </span>
</span><span class='line'><span class="c1">// based on comparisons of the head and last </span>
</span><span class='line'><span class="c1">// characters in a string</span>
</span><span class='line'><span class="k">def</span> <span class="n">byStringHelper</span><span class="o">(</span><span class="n">n</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Base case; empty string and single characters</span>
</span><span class='line'>  <span class="c1">// are by definition palindromes.  Place this test</span>
</span><span class='line'>  <span class="c1">// up front so that we can handle input values of</span>
</span><span class='line'>  <span class="c1">// a single character.</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">n</span><span class="o">.</span><span class="n">last</span><span class="o">)</span>
</span><span class='line'>    <span class="kc">false</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">byStringHelper</span><span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="n">n</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// String-based predicate; convert to string and call</span>
</span><span class='line'><span class="c1">// the recursive function</span>
</span><span class='line'><span class="k">def</span> <span class="n">byString</span><span class="o">(</span><span class="n">arg</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">Boolean</span> <span class="o">=</span> <span class="n">byStringHelper</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also not bad, but still not completely satisfying. Moving away from the use of regular expressions minimizes the benefit of mapping the input integer onto a String in order to solve the problem. Recall that the primary argument for doing so was the inability to access leading digits in an input integer. How significant is this constraint? Is it something we can work around? More on this next time.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/10/ruby-perl-and-eloquence/">Ruby, Perl and Eloquence</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/25/musings-on-list-comprehensions-functional-programming-and-python/">Musings on List Comprehensions, Functional Programming and Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/05/24/cassandra-and-clojure-the-beginning-of-a-beautiful-friendship/">Cassandra and Clojure: The Beginning of a Beautiful Friendship</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/03/29/data-models-and-cassandra/">Data Models and Cassandra</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/02/04/forks-and-joins-in-scala/">Forks and Joins in Scala</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/absurdfarce">@absurdfarce</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'absurdfarce',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bret McGuire -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
